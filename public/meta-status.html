<!DOCTYPE html>
<html>
  <head>
    <title>Meta Accounts Status</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
        line-height: 1.6;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 25% 25%,
            rgba(59, 130, 246, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(16, 185, 129, 0.05) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: -1;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
      }

      .header {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        padding: 25px 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        color: #f8fafc;
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-buttons {
        display: flex;
        gap: 12px;
      }

      .refresh-button, .back-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.8) 0%,
          rgba(99, 102, 241, 0.8) 100%
        );
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .refresh-button:hover, .back-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
      }

      .back-button {
        background: linear-gradient(
          135deg,
          rgba(75, 85, 99, 0.8) 0%,
          rgba(107, 114, 128, 0.8) 100%
        );
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        padding: 20px;
        border-radius: 16px;
        text-align: center;
      }

      .stat-number {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #94a3b8;
        font-size: 14px;
      }

      .stat-ready .stat-number { color: #10b981; }
      .stat-disconnected .stat-number { color: #ef4444; }
      .stat-pending .stat-number { color: #f59e0b; }

      .accounts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .account-card {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        padding: 20px;
        border-radius: 16px;
        transition: all 0.3s ease;
      }

      .account-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .account-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .account-name {
        font-size: 18px;
        font-weight: 600;
        color: #f8fafc;
      }

      .account-company {
        color: #94a3b8;
        font-size: 13px;
        margin-top: 4px;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-ready {
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(16, 185, 129, 0.9));
        color: #ecfdf5;
      }

      .status-disconnected {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(239, 68, 68, 0.9));
        color: #fef2f2;
      }

      .status-pending, .status-initializing {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.9), rgba(245, 158, 11, 0.9));
        color: #1a1a1a;
      }

      .status-unknown {
        background: linear-gradient(135deg, rgba(75, 85, 99, 0.9), rgba(107, 114, 128, 0.9));
        color: #f9fafb;
      }

      .account-details {
        display: grid;
        gap: 10px;
        margin-bottom: 15px;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
      }

      .detail-label {
        color: #94a3b8;
      }

      .detail-value {
        color: #e2e8f0;
        font-family: monospace;
      }

      .account-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(51, 65, 85, 0.5);
      }

      .action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .verify-btn {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.8));
        color: white;
      }

      .verify-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
      }

      .verify-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .delete-btn {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.8), rgba(185, 28, 28, 0.8));
        color: white;
      }

      .delete-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
      }

      .verification-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .verification-result.error {
        background: rgba(220, 38, 38, 0.1);
        border-color: rgba(220, 38, 38, 0.3);
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #94a3b8;
      }

      .spinner {
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #94a3b8;
      }

      .empty-state h3 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #e2e8f0;
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
        color: white;
        font-size: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }

      .notification.error {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(185, 28, 28, 0.9));
      }

      .connection-type-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 8px;
      }

      .type-meta_direct {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
      }

      .type-meta_embedded {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
      }

      .type-360dialog {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
      }

      .quality-rating {
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
      }

      .quality-GREEN { background: rgba(16, 185, 129, 0.2); color: #34d399; }
      .quality-YELLOW { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
      .quality-RED { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Meta WhatsApp Accounts Status</h1>
        <div class="header-buttons">
          <a href="/status.html" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Bot Status
          </a>
          <button class="refresh-button" onclick="loadAccounts()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card stat-ready">
          <div class="stat-number" id="readyCount">-</div>
          <div class="stat-label">Ready / Connected</div>
        </div>
        <div class="stat-card stat-disconnected">
          <div class="stat-number" id="disconnectedCount">-</div>
          <div class="stat-label">Disconnected</div>
        </div>
        <div class="stat-card stat-pending">
          <div class="stat-number" id="pendingCount">-</div>
          <div class="stat-label">Pending / Other</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCount">-</div>
          <div class="stat-label">Total Accounts</div>
        </div>
      </div>

      <div id="accountsContainer">
        <div class="loading">
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Loading accounts...
        </div>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
      let accounts = [];

      async function loadAccounts() {
        const container = document.getElementById('accountsContainer');
        container.innerHTML = `
          <div class="loading">
            <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            Loading accounts...
          </div>
        `;

        try {
          const response = await fetch('/api/whatsapp/meta-accounts');
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to load accounts');
          }

          accounts = data.accounts;
          renderAccounts();
          updateStats();
        } catch (error) {
          console.error('Error loading accounts:', error);
          container.innerHTML = `
            <div class="empty-state">
              <h3>Error Loading Accounts</h3>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      function renderAccounts() {
        const container = document.getElementById('accountsContainer');

        if (accounts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>No Meta Accounts Found</h3>
              <p>Connect your first WhatsApp number using the Embedded Signup flow in the CRM.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `<div class="accounts-grid">${accounts.map(renderAccountCard).join('')}</div>`;
      }

      function renderAccountCard(account) {
        const statusClass = getStatusClass(account.status);
        const typeClass = `type-${account.connectionType}`;

        return `
          <div class="account-card" id="account-${account.companyId}-${account.phoneIndex}">
            <div class="account-header">
              <div>
                <div class="account-name">
                  ${account.displayPhoneNumber || 'Unknown Number'}
                  <span class="connection-type-badge ${typeClass}">${formatConnectionType(account.connectionType)}</span>
                </div>
                <div class="account-company">${account.companyName || account.companyId}</div>
              </div>
              <span class="status-badge ${statusClass}">${account.status || 'unknown'}</span>
            </div>

            <div class="account-details">
              <div class="detail-row">
                <span class="detail-label">Company ID</span>
                <span class="detail-value">${account.companyId}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Phone Index</span>
                <span class="detail-value">${account.phoneIndex}</span>
              </div>
              ${account.phoneNumberId ? `
              <div class="detail-row">
                <span class="detail-label">Phone Number ID</span>
                <span class="detail-value">${account.phoneNumberId}</span>
              </div>
              ` : ''}
              ${account.wabaId ? `
              <div class="detail-row">
                <span class="detail-label">WABA ID</span>
                <span class="detail-value">${account.wabaId}</span>
              </div>
              ` : ''}
              <div class="detail-row">
                <span class="detail-label">Last Updated</span>
                <span class="detail-value">${formatDate(account.updatedAt)}</span>
              </div>
            </div>

            <div id="verification-${account.companyId}-${account.phoneIndex}"></div>

            <div class="account-actions">
              <button class="action-btn verify-btn" onclick="verifyAccount('${account.companyId}', ${account.phoneIndex})">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Verify with Meta
              </button>
              <button class="action-btn delete-btn" onclick="deleteAccount('${account.companyId}', ${account.phoneIndex})">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Remove
              </button>
            </div>
          </div>
        `;
      }

      function getStatusClass(status) {
        if (!status) return 'status-unknown';
        const s = status.toLowerCase();
        if (s === 'ready' || s === 'connected') return 'status-ready';
        if (s === 'disconnected' || s === 'error') return 'status-disconnected';
        if (s === 'pending' || s === 'initializing') return 'status-pending';
        return 'status-unknown';
      }

      function formatConnectionType(type) {
        if (type === 'meta_direct') return 'Meta Direct';
        if (type === 'meta_embedded') return 'Embedded Signup';
        if (type === '360dialog') return '360dialog';
        return type;
      }

      function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      }

      function updateStats() {
        const ready = accounts.filter(a => ['ready', 'connected'].includes(a.status?.toLowerCase())).length;
        const disconnected = accounts.filter(a => ['disconnected', 'error'].includes(a.status?.toLowerCase())).length;
        const pending = accounts.length - ready - disconnected;

        document.getElementById('readyCount').textContent = ready;
        document.getElementById('disconnectedCount').textContent = disconnected;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('totalCount').textContent = accounts.length;
      }

      async function verifyAccount(companyId, phoneIndex) {
        const verifyContainer = document.getElementById(`verification-${companyId}-${phoneIndex}`);
        const btn = event.target.closest('.verify-btn');

        btn.disabled = true;
        btn.innerHTML = `
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Verifying...
        `;

        try {
          const response = await fetch(`/api/whatsapp/meta-accounts/${companyId}/${phoneIndex}/verify`);
          const data = await response.json();

          if (data.success) {
            verifyContainer.innerHTML = `
              <div class="verification-result">
                <strong>Verification Successful</strong><br>
                Display Name: ${data.verifiedName || '-'}<br>
                Status: ${data.status || '-'}<br>
                Quality: <span class="quality-rating quality-${data.qualityRating}">${data.qualityRating || '-'}</span>
              </div>
            `;
            showNotification('Account verified successfully');

            // Update the status badge
            const card = document.getElementById(`account-${companyId}-${phoneIndex}`);
            const badge = card.querySelector('.status-badge');
            const newStatus = data.status === 'CONNECTED' ? 'ready' : data.status?.toLowerCase() || 'unknown';
            badge.className = `status-badge ${getStatusClass(newStatus)}`;
            badge.textContent = newStatus;

            // Update local data
            const account = accounts.find(a => a.companyId === companyId && a.phoneIndex === phoneIndex);
            if (account) account.status = newStatus;
            updateStats();
          } else {
            verifyContainer.innerHTML = `
              <div class="verification-result error">
                <strong>Verification Failed</strong><br>
                ${data.error || 'Unknown error'}
              </div>
            `;
            showNotification(data.error || 'Verification failed', true);
          }
        } catch (error) {
          verifyContainer.innerHTML = `
            <div class="verification-result error">
              <strong>Error</strong><br>
              ${error.message}
            </div>
          `;
          showNotification('Error verifying account', true);
        } finally {
          btn.disabled = false;
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Verify with Meta
          `;
        }
      }

      async function deleteAccount(companyId, phoneIndex) {
        if (!confirm(`Are you sure you want to remove this WhatsApp connection?\n\nCompany: ${companyId}\nPhone Index: ${phoneIndex}`)) {
          return;
        }

        try {
          const response = await fetch(`/api/whatsapp/config/${companyId}/${phoneIndex}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            showNotification('Account removed successfully');
            loadAccounts(); // Refresh the list
          } else {
            const data = await response.json();
            throw new Error(data.error || 'Failed to remove account');
          }
        } catch (error) {
          showNotification(error.message, true);
        }
      }

      function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification show ${isError ? 'error' : ''}`;

        setTimeout(() => {
          notification.className = 'notification';
        }, 3000);
      }

      // Initial load
      loadAccounts();

      // Auto-refresh every 30 seconds
      setInterval(loadAccounts, 30000);
    </script>
  </body>
</html>

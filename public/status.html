<!DOCTYPE html>
<html>
  <head>
    <title>Bot Status 2</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
        line-height: 1.6;
        min-height: 100vh;
        position: relative;
      }

      /* Futuristic background pattern */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 25% 25%,
            rgba(59, 130, 246, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(139, 92, 246, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(16, 185, 129, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: -1;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
      }

      .header {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        padding: 25px 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04),
          inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(59, 130, 246, 0.5),
          transparent
        );
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        color: #f8fafc;
        text-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .logs-button,
      .refresh-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 18px;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.8) 0%,
          rgba(99, 102, 241, 0.8) 100%
        );
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        border: 1px solid rgba(59, 130, 246, 0.3);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        cursor: pointer;
        min-height: 44px;
        min-width: 120px;
        justify-content: center;
      }

      .logs-button::before,
      .refresh-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .logs-button:hover::before,
      .refresh-button:hover::before {
        left: 100%;
      }

      .logs-button:hover,
      .refresh-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        border-color: rgba(59, 130, 246, 0.5);
      }

      .search-container {
        margin-bottom: 30px;
      }

      .search-input {
        width: 100%;
        padding: 16px 20px;
        font-size: 16px;
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 16px;
        color: #e2e8f0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .search-input:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1),
          inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 30px rgba(59, 130, 246, 0.2);
        transform: translateY(-1px);
      }

      .search-input::placeholder {
        color: #64748b;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        padding: 24px;
        border-radius: 16px;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.5),
          rgba(139, 92, 246, 0.5),
          rgba(16, 185, 129, 0.5)
        );
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: rgba(59, 130, 246, 0.4);
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
      }

      .stat-label {
        color: #94a3b8;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .bot-list {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .bot-list::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(59, 130, 246, 0.5),
          transparent
        );
      }

      .bot-item {
        padding: 20px 25px;
        border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        display: grid;
        grid-template-columns: 2fr 1fr 2fr;
        gap: 20px;
        align-items: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      .bot-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(
          180deg,
          rgba(59, 130, 246, 0.5),
          rgba(139, 92, 246, 0.5)
        );
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .bot-item:last-child {
        border-bottom: none;
      }

      .bot-item:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.05) 0%,
          rgba(139, 92, 246, 0.05) 100%
        );
        transform: translateX(4px);
      }

      .bot-item:hover::before {
        opacity: 1;
      }

      .bot-item.hidden {
        display: none;
      }

      .bot-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: left;
      }

      .bot-display-name {
        font-size: 16px;
        font-weight: 600;
        color: #f8fafc;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      }

      .bot-id {
        font-size: 13px;
        color: #94a3b8;
        font-family: "JetBrains Mono", monospace;
        opacity: 0.8;
      }

      .bot-status {
        justify-self: center;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        min-width: 100px;
        max-width: 140px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      .bot-status::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .bot-status:hover::before {
        left: 100%;
      }

      .status-ready {
        background: linear-gradient(
          135deg,
          rgba(5, 150, 105, 0.9),
          rgba(16, 185, 129, 0.9)
        );
        color: #ecfdf5;
        box-shadow: 0 0 20px rgba(5, 150, 105, 0.3);
      }

      .status-qr {
        background: linear-gradient(
          135deg,
          rgba(234, 179, 8, 0.9),
          rgba(245, 158, 11, 0.9)
        );
        color: #1a1a1a;
        box-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
      }

      .status-error {
        background: linear-gradient(
          135deg,
          rgba(220, 38, 38, 0.9),
          rgba(239, 68, 68, 0.9)
        );
        color: #fef2f2;
        box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
      }

      .status-initializing {
        background: linear-gradient(
          135deg,
          rgba(37, 99, 235, 0.9),
          rgba(59, 130, 246, 0.9)
        );
        color: #eff6ff;
        box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
      }

      .status-authenticated {
        background: linear-gradient(
          135deg,
          rgba(124, 58, 237, 0.9),
          rgba(139, 92, 246, 0.9)
        );
        color: #f5f3ff;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
      }

      .status-disconnected {
        background: linear-gradient(
          135deg,
          rgba(75, 85, 99, 0.9),
          rgba(107, 114, 128, 0.9)
        );
        color: #f9fafb;
        box-shadow: 0 0 20px rgba(75, 85, 99, 0.3);
      }

      .bot-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
      }

      .bot-actions button {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        white-space: nowrap;
        min-width: 80px;
      }

      .bot-actions button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .bot-actions button:hover::before {
        left: 100%;
      }

      .bot-actions button:hover {
        transform: translateY(-2px);
      }

      .reinit-button {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.8),
          rgba(99, 102, 241, 0.8)
        );
        color: white;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .reinit-button:hover {
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .delete-trial-button {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.8),
          rgba(220, 38, 38, 0.8)
        );
        color: white;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .delete-trial-button:hover {
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      .disconnect-button {
        background: linear-gradient(
          135deg,
          rgba(251, 146, 60, 0.8),
          rgba(245, 101, 101, 0.8)
        );
        color: white;
        border: 1px solid rgba(251, 146, 60, 0.3);
      }

      .disconnect-button:hover {
        box-shadow: 0 8px 25px rgba(251, 146, 60, 0.3);
      }

      .delete-company-button {
        background: linear-gradient(
          135deg,
          rgba(127, 29, 29, 0.8),
          rgba(153, 27, 27, 0.8)
        );
        color: white;
        border: 1px solid rgba(127, 29, 29, 0.3);
      }

      .delete-company-button:hover {
        box-shadow: 0 8px 25px rgba(127, 29, 29, 0.3);
      }

      .debug-button {
        background: linear-gradient(
          135deg,
          rgba(107, 114, 128, 0.8) 0%,
          rgba(75, 85, 99, 0.8) 100%
        ) !important;
        border: 1px solid rgba(107, 114, 128, 0.3) !important;
      }

      .debug-button:hover {
        box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3) !important;
      }

      .phone-index {
        color: #8b5cf6;
        font-size: 14px;
        font-weight: 600;
        margin-left: 8px;
        text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
      }

      .connection-status {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 12px 20px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.95),
          rgba(51, 65, 85, 0.95)
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        font-size: 14px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .no-results {
        text-align: center;
        padding: 20px;
        color: #94a3b8;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .refresh-button.loading svg {
        animation: spin 1s linear infinite;
      }

      .notification {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 16px 24px;
        border-radius: 16px;
        background: linear-gradient(
          135deg,
          rgba(5, 150, 105, 0.95) 0%,
          rgba(16, 185, 129, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(5, 150, 105, 0.3);
        color: white;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2),
          0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 30px rgba(5, 150, 105, 0.3);
        animation: slideUp 0.3s ease-out, fadeOut 0.5s ease-out 2.5s forwards;
        z-index: 10000;
        overflow: hidden;
        max-width: 90vw;
        text-align: center;
      }

      .notification::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.5),
          rgba(255, 255, 255, 0.8),
          rgba(255, 255, 255, 0.5)
        );
      }

      @keyframes slideUp {
        from {
          transform: translate(-50%, 100%);
        }
        to {
          transform: translate(-50%, 0);
        }
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
          visibility: hidden;
        }
      }

      .header-buttons {
        display: flex;
        gap: 12px;
      }

      .controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .controls button {
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
      }

      .controls button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      #initAutomationsButton {
        background-color: #2196f3;
      }

      .plan-badge,
      .trial-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      .plan-badge.enterprise {
        background: #6366f1;
        color: white;
      }

      .plan-badge.pro {
        background: #8b5cf6;
        color: white;
      }

      .plan-badge.basic {
        background: #10b981;
        color: white;
      }

      .trial-badge {
        background: #f59e0b;
        color: white;
      }

      .trial-info {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }

      .delete-trial-button {
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.8),
          rgba(220, 38, 38, 0.8)
        );
        color: white;
        border: 1px solid rgba(239, 68, 68, 0.3);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .delete-trial-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .delete-trial-button:hover::before {
        left: 100%;
      }

      .delete-trial-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      .bot-activity {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        gap: 8px;
      }

      .bot-activity .dot {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }

      .auto-reply-section {
        margin-top: 20px;
      }

      .auto-reply-test-section {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin: 30px 0;
        position: relative;
        overflow: hidden;
      }

      .auto-reply-test-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          rgba(245, 158, 11, 0.5),
          rgba(251, 191, 36, 0.5),
          rgba(245, 158, 11, 0.5)
        );
      }

      .auto-reply-test-section h3 {
        color: #fbbf24;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }

      .auto-reply-controls {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }

      .modern-select {
        padding: 12px 16px;
        background: rgba(51, 65, 85, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 12px;
        color: #f8fafc;
        font-size: 14px;
        font-weight: 500;
        min-width: 140px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }

      .modern-select:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
      }

      .modern-select:hover {
        border-color: rgba(59, 130, 246, 0.3);
      }

      .modern-input {
        padding: 12px 16px;
        background: rgba(51, 65, 85, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 12px;
        color: #f8fafc;
        font-size: 14px;
        font-weight: 500;
        width: 220px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .modern-input:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
      }

      .modern-input::placeholder {
        color: #94a3b8;
      }

      .modern-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      .modern-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .modern-button:hover::before {
        left: 100%;
      }

      .modern-button:hover {
        transform: translateY(-2px);
      }

      .test-button {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.9),
          rgba(251, 191, 36, 0.9)
        );
        color: #1a1a1a;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }

      .test-button:hover {
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
      }

      /* Add table header */
      .bot-list-header {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr;
        gap: 20px;
        padding: 16px 25px;
        background: linear-gradient(
          135deg,
          rgba(40, 53, 72, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        font-size: 13px;
        font-weight: 600;
        color: #94a3b8;
        align-items: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .bot-list-header span {
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Align header columns */
      .bot-list-header span:nth-child(1) {
        text-align: left;
      }
      .bot-list-header span:nth-child(2) {
        text-align: center;
      }
      .bot-list-header span:nth-child(3) {
        text-align: right;
      }

      /* Ensure status aligns with its header */
      .bot-status {
        margin: 0 auto;
        display: block;
      }

      /* Auto-Reply Management Styles */
      .auto-reply-section {
        margin-bottom: 20px;
      }

      .auto-reply-section h2 {
        color: #f8fafc;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .auto-reply-section h2 svg {
        fill: #f59e0b; /* Gold color for auto-reply icon */
      }

      .auto-reply-section .test-section {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      .auto-reply-section .test-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          rgba(245, 158, 11, 0.5),
          rgba(251, 191, 36, 0.5)
        );
      }

      .auto-reply-section h3 {
        color: #fbbf24;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }

      .auto-reply-section .test-section div {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .auto-reply-section .test-section select,
      .auto-reply-section .test-section input,
      .auto-reply-section .test-section button {
        padding: 10px 16px;
        background: rgba(51, 65, 85, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 10px;
        color: #f8fafc;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .auto-reply-section .test-section select:focus,
      .auto-reply-section .test-section input:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .auto-reply-section .test-section button {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.8),
          rgba(251, 191, 36, 0.8)
        );
        color: white;
        border: 1px solid rgba(245, 158, 11, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .auto-reply-section .test-section button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s;
      }

      .auto-reply-section .test-section button:hover::before {
        left: 100%;
      }

      .auto-reply-section .test-section button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
      }

      .auto-reply-section .company-auto-reply-card {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9) 0%,
          rgba(51, 65, 85, 0.9) 100%
        );
        backdrop-filter: blur(20px);
        border: 1px solid rgba(51, 65, 85, 0.3);
        border-radius: 16px;
        padding: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .auto-reply-section .company-auto-reply-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(16, 185, 129, 0.5),
          transparent
        );
      }

      .auto-reply-section .company-auto-reply-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .auto-reply-section .company-auto-reply-card h4 {
        color: #f8fafc;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 0 15px rgba(248, 250, 252, 0.1);
      }

      .auto-reply-section .company-auto-reply-card .auto-reply-status {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          rgba(75, 85, 99, 0.8),
          rgba(107, 114, 128, 0.8)
        );
        color: #f9fafb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .auto-reply-section .company-auto-reply-card .auto-reply-stats {
        font-size: 13px;
        color: #94a3b8;
        margin-top: 12px;
      }

      .auto-reply-section .company-auto-reply-card .auto-reply-stats div {
        margin-bottom: 6px;
        padding: 4px 0;
      }

      .auto-reply-section
        .company-auto-reply-card
        .auto-reply-stats
        .last-check {
        color: #fbbf24;
        font-weight: 500;
      }

      .auto-reply-section
        .company-auto-reply-card
        .auto-reply-stats
        .messages-replied {
        color: #10b981;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div
      id="passwordModal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.98) 0%,
          rgba(30, 41, 59, 0.98) 100%
        );
        backdrop-filter: blur(20px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      "
    >
      <div
        style="
          background: linear-gradient(
            135deg,
            rgba(30, 41, 59, 0.95) 0%,
            rgba(51, 65, 85, 0.95) 100%
          );
          backdrop-filter: blur(30px);
          border: 1px solid rgba(51, 65, 85, 0.3);
          padding: 3rem;
          border-radius: 20px;
          width: 90%;
          max-width: 450px;
          text-align: center;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          position: relative;
          overflow: hidden;
        "
      >
        <div
          style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(
              90deg,
              rgba(59, 130, 246, 0.5),
              rgba(139, 92, 246, 0.5),
              rgba(16, 185, 129, 0.5)
            );
          "
        ></div>
        <h2
          style="
            margin-bottom: 2rem;
            color: #f8fafc;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #f8fafc 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          "
        >
          Enter Password
        </h2>
        <input
          type="password"
          id="passwordInput"
          class="search-input"
          style="
            margin-bottom: 2rem;
            background: rgba(51, 65, 85, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.3);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
          "
          placeholder="Password"
        />
        <button
          onclick="checkPassword()"
          class="refresh-button"
          style="
            width: 100%;
            background: linear-gradient(
              135deg,
              rgba(59, 130, 246, 0.8) 0%,
              rgba(99, 102, 241, 0.8) 100%
            );
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
          "
        >
          Submit
        </button>
      </div>
    </div>

    <div id="mainContent" style="display: none">
      <div class="container">
        <div class="header">
          <h1>Bot Status Monitor</h1>
          <div class="header-buttons">
            <button onclick="window.location.href='/logs'" class="logs-button">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <line x1="10" y1="9" x2="8" y2="9" />
              </svg>
              Logs
            </button>
            <button
              onclick="debugBotStatuses()"
              class="refresh-button debug-button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4" />
                <path d="M12 8h.01" />
              </svg>
              Debug Status
            </button>
            <button
              onclick="cleanupAllJobs()"
              class="refresh-button"
              id="cleanupJobsButton"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 6h18" />
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                <line x1="10" y1="11" x2="10" y2="17" />
                <line x1="14" y1="11" x2="14" y2="17" />
              </svg>
              Cleanup Jobs
            </button>
            <button
              onclick="initializeAutomations()"
              class="refresh-button"
              id="initAutomationsButton"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"
                />
              </svg>
              Initialize Automations
            </button>
            <button
              onclick="reinitializeAllPending()"
              class="refresh-button"
              id="refreshButton"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"
                />
              </svg>
              Reinitialize Pending
            </button>
          </div>
        </div>
        <!-- Auto-Reply Test Section -->
        <div class="auto-reply-test-section">
          <h3>ðŸ§ª Test Auto-Reply</h3>
          <div class="auto-reply-controls">
            <select id="testCompanySelect" class="modern-select">
              <option value="">Select Company</option>
              <option value="0380">Company 0380</option>
              <option value="001">Company 001</option>
              <option value="002">Company 002</option>
              <option value="003">Company 003</option>
              <option value="004">Company 004</option>
            </select>
            <input
              type="text"
              id="testPhoneNumber"
              placeholder="Phone (e.g., +601121677522)"
              value="+601121677522"
              class="modern-input"
            />
            <select id="testHoursSelect" class="modern-select">
              <option value="1">1 hour</option>
              <option value="6">6 hours</option>
              <option value="12">12 hours</option>
              <option value="24" selected>24 hours</option>
              <option value="48">48 hours</option>
            </select>
            <button
              onclick="testAutoReply()"
              class="modern-button test-button"
              id="testAutoReplyButton"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 12l2 2 4-4" />
                <path
                  d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.35 0 4.48.9 6.08 2.38l.94-.94"
                />
              </svg>
              Test Auto-Reply
            </button>
          </div>
        </div>

        <div class="search-container">
          <input
            type="text"
            id="searchInput"
            placeholder="Search bots..."
            class="search-input"
          />
        </div>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalBots">0</div>
            <div class="stat-label">Total Bots</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeBots">0</div>
            <div class="stat-label">Connected Bots</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="disconnectedBots">0</div>
            <div class="stat-label">Disconnected</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentlyActiveBots">0</div>
            <div class="stat-label">Currently Active</div>
          </div>
        </div>
        <div id="categoryGroups"></div>
      </div>
      <div id="connectionStatus" class="connection-status">
        Connected to server
      </div>
    </div>

    <script>
      function checkPassword() {
        const password = document.getElementById("passwordInput").value;
        if (password === "P@ssw0rd") {
          sessionStorage.setItem("statusAuth", "true");
          showMainContent();
        } else {
          alert("Incorrect password");
        }
      }

      function showMainContent() {
        document.getElementById("passwordModal").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        initialize(); // Initialize the main content
      }

      // Check for existing auth when page loads
      if (sessionStorage.getItem("statusAuth") === "true") {
        showMainContent();
      }

      // Add password input enter key handler
      document
        .getElementById("passwordInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            checkPassword();
          }
        });

      const statusDiv = document.getElementById("status");
      const connectionStatus = document.getElementById("connectionStatus");
      const searchInput = document.getElementById("searchInput");
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const botStatuses = new Map();
      let ws;
      const botActivityMap = new Map();

      let currentSearchTerm = "";

      searchInput.addEventListener("input", () => {
        currentSearchTerm = searchInput.value.toLowerCase();
        applyFilters();
      });

      function applyFilters() {
        const botItems = document.querySelectorAll(".bot-item");
        let hasVisibleItems = false;

        botItems.forEach((item) => {
          const botName = item
            .querySelector(".bot-display-name")
            .textContent.toLowerCase();
          const botId = item.querySelector(".bot-id").textContent.toLowerCase();
          const status = item
            .querySelector(".bot-status")
            .textContent.toLowerCase();
          const isActive = item.querySelector(".bot-activity") !== null;

          const matchesSearch =
            !currentSearchTerm ||
            botName.includes(currentSearchTerm) ||
            botId.includes(currentSearchTerm) ||
            status.includes(currentSearchTerm);

          const matchesActiveFilter = !showingOnlyActive || isActive;

          item.classList.toggle(
            "hidden",
            !matchesSearch || !matchesActiveFilter
          );
          if (matchesSearch && matchesActiveFilter) hasVisibleItems = true;
        });

        // Update no results message
        let noResults = document.getElementById("noResults");
        if (!hasVisibleItems) {
          if (!noResults) {
            noResults = document.createElement("div");
            noResults.id = "noResults";
            noResults.className = "no-results";
            noResults.textContent = "No bots found matching your search";
            document.querySelector(".bot-list").appendChild(noResults);
          }
        } else if (noResults) {
          noResults.remove();
        }

        updateFilteredStats();
      }

      function shouldAutoScroll() {
        return window.lastKeyPressed === "Enter";
      }

      let lastScrollTop = 0;
      window.lastKeyPressed = null;

      document.addEventListener("keydown", (e) => {
        window.lastKeyPressed = e.key;
        if (e.key === "Enter") {
          // Reset after a short delay
          setTimeout(() => {
            window.lastKeyPressed = null;
          }, 1000);
        }
      });

      function renderStatuses() {
        // Store current scroll position
        lastScrollTop =
          window.pageYOffset || document.documentElement.scrollTop;

        const categoryGroups = new Map();
        const sortedBots = Array.from(botStatuses.entries()).sort((a, b) => {
          const [nameA] = a[0].split("_");
          const [nameB] = b[0].split("_");
          return nameA.localeCompare(nameB);
        });

        // Group bots by category
        for (const [key, data] of sortedBots) {
          const [botName] = key.split("_");
          const botData = window.botsData?.find((b) => b.botName === botName);
          const category = botData?.category || "juta";

          if (!categoryGroups.has(category)) {
            categoryGroups.set(category, new Map());
          }
          if (!categoryGroups.get(category).has(botName)) {
            categoryGroups.get(category).set(botName, []);
          }
          categoryGroups
            .get(category)
            .get(botName)
            .push({ ...data, key });
        }

        const categoryGroupsDiv = document.getElementById("categoryGroups");
        categoryGroupsDiv.innerHTML = "";

        // Render each category group
        for (const [category, botsInCategory] of categoryGroups) {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "category-group";

          // Create bot list for this category
          const botListDiv = document.createElement("div");
          botListDiv.className = "bot-list";

          // Add table header
          const headerDiv = document.createElement("div");
          headerDiv.className = "bot-list-header";
          headerDiv.innerHTML = `
                    <span>Bot Information</span>
                    <span>Status</span>
                    <span>Actions</span>
                `;
          botListDiv.appendChild(headerDiv);

          for (const [botName, phones] of botsInCategory) {
            const botData = window.botsData?.find((b) => b.botName === botName);
            const displayName = botData?.name || botName;
            const isActive = botActivityMap.get(botName);
            const employeeEmails = botData?.employeeEmails || [];

            phones.forEach(({ status, phoneIndex }, index) => {
              const botItem = document.createElement("div");
              botItem.className = "bot-item";
              botItem.id = `bot-${botName}-${phoneIndex}`;

              const phoneNumber = botData?.clientPhones?.[phoneIndex];
              const phoneLabel =
                phones.length > 1 ? ` (Phone ${index + 1})` : "";

              const activityIndicator =
                index === 0 && isActive
                  ? `
                            <div class="bot-activity">
                                <span class="dot"></span>
                                Currently Active
                            </div>
                        `
                  : "";

              // Add category select to each bot's actions
              const categorySelect = `
                            <select class="category-select" onchange="updateBotCategory('${botName}', this.value)">
                                <option value="">Move to...</option>
                                <option value="juta" ${
                                  category === "juta" ? "disabled" : ""
                                }>Juta</option>
                                <option value="omniyal" ${
                                  category === "omniyal" ? "disabled" : ""
                                }>Omniyal</option>
                                <option value="zahin" ${
                                  category === "zahin" ? "disabled" : ""
                                }>Zahin</option>
                            </select>
                        `;

              botItem.innerHTML = `
                            <div class="bot-info">
                                <div class="bot-display-name">
                                    ${displayName}${phoneLabel}
                                    ${
                                      botData?.plan
                                        ? `<span class="plan-badge ${botData.plan.toLowerCase()}">${
                                            botData.plan
                                          }</span>`
                                        : ""
                                    }
                                    ${
                                      botData?.trialEndDate
                                        ? '<span class="trial-badge">Trial</span>'
                                        : ""
                                    }
                                    ${activityIndicator}
                                </div>
                                <div class="bot-id">ID: ${botName}</div>
                                ${
                                  phoneNumber
                                    ? `<div class="bot-id">Phones: ${phoneNumber}</div>`
                                    : `<div class="bot-id">Phone${
                                        phones.length > 1
                                          ? " " + (index + 1)
                                          : ""
                                      }: Not Set</div>`
                                }
                            </div>
                            <span class="bot-status status-${status.toLowerCase()}">${status}</span>
                            <div class="bot-actions">
                                ${
                                  botData?.trialEndDate
                                    ? `
                                    <button class="delete-trial-button" onclick="deleteTrialEndDate('${botName}')">
                                        Delete Trial
                                    </button>
                                `
                                    : ""
                                }
                                ${
                                  index === 0
                                    ? `
                                    <button class="reinit-button" onclick="showUnrepliedMessages('${
                                      botData?.companyId || botName
                                    }')" style="background: #3b82f6; margin-right: 4px;">
                                        View Unreplied
                                    </button>
                                `
                                    : ""
                                }
                                ${
                                  phones.length === 1
                                    ? `
                                    <button class="reinit-button" onclick="reinitializeBot('${botName}', ${phoneIndex})">
                                        Reinitialize
                                    </button>
                                    <button class="disconnect-button" onclick="disconnectBot('${botName}', ${phoneIndex})">
                                        Disconnect
                                    </button>
                                    `
                                    : `
                                    <button class="reinit-button" onclick="reinitializeBot('${botName}', ${phoneIndex})">
                                        Reinitialize Phone ${phoneIndex + 1}
                                    </button>
                                    <button class="disconnect-button" onclick="disconnectBot('${botName}', ${phoneIndex})">
                                        Disconnect Phone ${phoneIndex + 1}
                                    </button>
                                    `
                                }
                                ${
                                  index === 0 && phones.length > 1
                                    ? `
                                    <button class="reinit-button" onclick="reinitializeBot('${botName}')">
                                        Reinitialize All
                                    </button>
                                    <button class="disconnect-button" onclick="disconnectBot('${botName}')">
                                        Disconnect All
                                    </button>
                                    `
                                    : ""
                                }
                                ${
                                  index === 0
                                    ? `
                                    <button class="delete-company-button" onclick="deleteCompany('${botName}')">
                                        Delete Company
                                    </button>
                                    `
                                    : ""
                                }
                            </div>
                        `;

              botListDiv.appendChild(botItem);
            });
          }

          categoryDiv.appendChild(botListDiv);
          categoryGroupsDiv.appendChild(categoryDiv);
        }

        // Apply current filters after rendering
        applyFilters();

        // After rendering, handle scroll position
        if (!shouldAutoScroll()) {
          setTimeout(() => {
            window.scrollTo(0, lastScrollTop);
          }, 0);
        }
      }

      function updateBotStatus(botName, status, phoneIndex = 0, qrCode = null) {
        const botKey = `${botName}_${phoneIndex}`;

        // Find the bot data from the stored botsData
        const botData = window.botsData?.find((b) => b.botName === botName);

        botStatuses.set(botKey, {
          status,
          phoneIndex,
          qrCode,
          displayName: botData?.name,
          clientPhone: botData?.clientPhones?.[phoneIndex],
          employeeEmails: botData?.employeeEmails,
        });

        renderStatuses();
        if (searchInput.value) {
          filterBots(searchInput.value.toLowerCase());
        } else {
          updateStats();
        }
      }

      function updateStats() {
        // Count unique bots (ignoring phone indices)
        const uniqueBots = new Set(
          Array.from(botStatuses.keys()).map((key) => key.split("_")[0])
        );
        const totalBots = uniqueBots.size;

        // Count active bots (ready or authenticated status)
        const activeBots = new Set(
          Array.from(botStatuses.entries())
            .filter(([, bot]) =>
              ["ready", "authenticated"].includes(bot.status.toLowerCase())
            )
            .map(([key]) => key.split("_")[0])
        ).size;

        // Count disconnected bots
        const disconnectedBots = new Set(
          Array.from(botStatuses.entries())
            .filter(([, bot]) =>
              ["disconnected", "error"].includes(bot.status.toLowerCase())
            )
            .map(([key]) => key.split("_")[0])
        ).size;

        // Count currently active bots
        const currentlyActiveBots = new Set(
          Array.from(botActivityMap.entries())
            .filter(([, isActive]) => isActive)
            .map(([botName]) => botName)
        ).size;

        document.getElementById("totalBots").textContent = totalBots;
        document.getElementById("activeBots").textContent = activeBots;
        document.getElementById("disconnectedBots").textContent =
          disconnectedBots;
        document.getElementById("currentlyActiveBots").textContent =
          currentlyActiveBots;
      }

      function filterBots(searchTerm) {
        const botItems = document.querySelectorAll(".bot-item");
        let hasVisibleItems = false;

        botItems.forEach((item) => {
          const botName = item
            .querySelector(".bot-display-name")
            .textContent.toLowerCase();
          const botId = item.querySelector(".bot-id").textContent.toLowerCase();
          const status = item
            .querySelector(".bot-status")
            .textContent.toLowerCase();

          const matches =
            botName.includes(searchTerm) ||
            botId.includes(searchTerm) ||
            status.includes(searchTerm);

          item.classList.toggle("hidden", !matches);
          if (matches) hasVisibleItems = true;
        });

        let noResults = document.getElementById("noResults");
        const categoryGroups = document.getElementById("categoryGroups"); // Get the container

        if (!hasVisibleItems) {
          if (!noResults) {
            noResults = document.createElement("div");
            noResults.id = "noResults";
            noResults.className = "no-results";
            noResults.textContent = "No bots found matching your search";
            categoryGroups.appendChild(noResults); // Append to categoryGroups instead
          }
        } else if (noResults) {
          noResults.remove();
        }

        updateFilteredStats();
      }

      function updateFilteredStats() {
        const visibleItems = document.querySelectorAll(
          ".bot-item:not(.hidden)"
        );
        const totalVisible = visibleItems.length;
        const activeVisible = Array.from(visibleItems).filter((item) =>
          ["ready", "authenticated"].includes(
            item.querySelector(".bot-status").textContent.toLowerCase()
          )
        ).length;
        const disconnectedVisible = Array.from(visibleItems).filter((item) =>
          ["disconnected", "error"].includes(
            item.querySelector(".bot-status").textContent.toLowerCase()
          )
        ).length;
        const currentlyActiveVisible = new Set(
          Array.from(visibleItems)
            .filter((item) => item.querySelector(".bot-activity"))
            .map((item) =>
              item.querySelector(".bot-id").textContent.split(":")[1].trim()
            )
        ).size;

        document.getElementById("totalBots").textContent = totalVisible;
        document.getElementById("activeBots").textContent = activeVisible;
        document.getElementById("disconnectedBots").textContent =
          disconnectedVisible;
        document.getElementById("currentlyActiveBots").textContent =
          currentlyActiveVisible;
      }

      async function initializeBots() {
        try {
          const response = await fetch("/api/bots");
          const bots = await response.json();
          console.log("Fetched bot data:", bots);

          // // Filter bots to only include those with juta.ngrok.app apiUrl
          // const jutaBots = bots.filter(
          //   (bot) => bot.apiUrl === "https://juta-dev.ngrok.dev"
          // );

          // Define the allowed company IDs
          const companyIds = ['0160', '0161', '0377', '063', '079', '092', '399849', '458752', '765943', '088', '296245', '0245', '0210', '0156', '0101', '728219', '0342', '049815'];

          // Filter bots to only include those with the specified companyIds
          const jutaBots = bots.filter(
            (bot) => companyIds.includes(bot.botName)
          );

          jutaBots.forEach((bot) => {
            const phoneCount = parseInt(bot.phoneCount) || 1;
            for (let i = 0; i < phoneCount; i++) {
              updateBotStatus(
                bot.botName,
                "Initializing",
                i,
                null,
                bot.name,
                bot.clientPhones?.[i] || null
              );
            }
          });

          // Store filtered bot data for later use
          window.botsData = jutaBots;

          // Populate the test company select with dynamic companies
          populateTestCompanySelect();
        } catch (error) {
          console.error("Error fetching bots:", error);
        }
      }

      function connectWebSocket() {
        ws = new WebSocket(`${protocol}//${window.location.host}/status`);

        ws.onmessage = (event) => {
          console.log("WebSocket message received:", event.data);
          const data = JSON.parse(event.data);

          if (data.type === "status_update") {
            // Get phone info from stored map
            const phoneInfo = window.phoneMap?.get(data.botName) || {};

            console.log(`Status Update for ${data.botName}:`, {
              status: data.status,
              phoneIndex: data.phoneIndex,
              clientPhone: phoneInfo.clientPhone,
              displayName: phoneInfo.displayName,
            });

            updateBotStatus(
              data.botName,
              data.status,
              data.phoneIndex,
              null,
              phoneInfo.displayName,
              phoneInfo.clientPhone
            );
          } else if (data.type === "bot_activity") {
            botActivityMap.set(data.botName, data.isActive);
            renderStatuses();
            updateStats(); // Make sure stats are updated
          }
        };

        ws.onopen = () => {
          console.log("WebSocket connected");
          connectionStatus.style.display = "block";
          connectionStatus.style.background = "#059669";
          connectionStatus.textContent = "Connected to server";
        };

        ws.onclose = () => {
          console.log("WebSocket disconnected");
          const reconnectMessage = document.createElement("div");
          reconnectMessage.className = "error";
          reconnectMessage.textContent = "Connection lost. Reconnecting...";
          connectionStatus.style.display = "block";
          connectionStatus.style.background = "#dc2626";
          connectionStatus.textContent = "Connection lost. Reconnecting...";

          // Attempt to reconnect after 3 seconds
          setTimeout(() => {
            connectWebSocket();
          }, 3000);
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          connectionStatus.style.display = "block";
          connectionStatus.style.background = "#dc2626";
          connectionStatus.textContent = "Connection error";
        };
      }

      async function initialize() {
        await initializeBots();
        connectWebSocket();
        // Update auto-reply status after main initialization
        setTimeout(updateAutoReplyStatus, 2000);
      }

      async function reinitializeBot(botName, phoneIndex) {
        const confirmMessage =
          phoneIndex !== undefined
            ? `Are you sure you want to reinitialize Phone ${
                phoneIndex + 1
              } of ${botName}?`
            : `Are you sure you want to reinitialize all phones of ${botName}?`;

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          // Show processing notification
          showNotification(
            `Reinitializing ${botName}${
              phoneIndex !== undefined ? ` Phone ${phoneIndex + 1}` : ""
            }...`
          );

          const response = await fetch("/api/bots/reinitialize", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ botName, phoneIndex }),
          });

          if (!response.ok) {
            throw new Error("Failed to reinitialize bot");
          }

          // Update status for specified phone or all phones
          if (phoneIndex !== undefined) {
            updateBotStatus(botName, "Initializing", phoneIndex);
          } else {
            const phones = Array.from(botStatuses.entries())
              .filter(([key]) => key.startsWith(botName + "_"))
              .map(([key]) => {
                const [, phoneIndex] = key.split("_");
                return parseInt(phoneIndex);
              });

            phones.forEach((idx) => {
              updateBotStatus(botName, "Initializing", idx);
            });
          }

          // Show success notification
          showNotification(
            `${botName}${
              phoneIndex !== undefined ? ` Phone ${phoneIndex + 1}` : ""
            } is being reinitialized`
          );
        } catch (error) {
          console.error("Error reinitializing bot:", error);
          showNotification(
            "Failed to reinitialize bot. Please try again.",
            true
          );
        }
      }

      async function disconnectBot(botName, phoneIndex) {
        const confirmMessage =
          phoneIndex !== undefined
            ? `Are you sure you want to disconnect Phone ${
                phoneIndex + 1
              } of ${botName}?`
            : `Are you sure you want to disconnect all phones of ${botName}?`;

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          // Show processing notification
          showNotification(
            `Disconnecting ${botName}${
              phoneIndex !== undefined ? ` Phone ${phoneIndex + 1}` : ""
            }...`
          );

          const response = await fetch(`/api/bots/${botName}/disconnect`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ phoneIndex }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to disconnect bot");
          }

          const data = await response.json();

          // Update status for specified phone or all phones
          if (phoneIndex !== undefined) {
            updateBotStatus(botName, "Disconnected", phoneIndex);
          } else {
            const phones = Array.from(botStatuses.entries())
              .filter(([key]) => key.startsWith(botName + "_"))
              .map(([key]) => {
                const [, phoneIndex] = key.split("_");
                return parseInt(phoneIndex);
              });

            phones.forEach((idx) => {
              updateBotStatus(botName, "Disconnected", idx);
            });
          }

          // Show success notification
          showNotification(
            data.message ||
              `${botName}${
                phoneIndex !== undefined ? ` Phone ${phoneIndex + 1}` : ""
              } disconnected successfully`
          );
        } catch (error) {
          console.error("Error disconnecting bot:", error);
          showNotification("Failed to disconnect bot. Please try again.", true);
        }
      }

      async function deleteCompany(botName) {
        // Double confirmation for delete operation
        const firstConfirm = confirm(
          `âš ï¸ WARNING: This will permanently delete company ${botName} and ALL its data!\n\nThis action cannot be undone. Are you sure?`
        );
        if (!firstConfirm) {
          return;
        }

        const secondConfirm = confirm(
          `ðŸ”´ FINAL CONFIRMATION\n\nYou are about to permanently delete:\n- Company ${botName}\n- All contacts\n- All messages\n- All employees\n- All settings\n- All related data\n\nType the company ID "${botName}" in the next prompt to confirm.`
        );
        if (!secondConfirm) {
          return;
        }

        // Require typing the company ID
        const confirmInput = prompt(
          `Please type "${botName}" to confirm deletion:`
        );
        if (confirmInput !== botName) {
          showNotification(
            "Company deletion cancelled - incorrect confirmation",
            true
          );
          return;
        }

        try {
          // Show processing notification
          showNotification(
            `Deleting company ${botName}... This may take a moment.`
          );

          const response = await fetch(`/api/companies/${botName}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to delete company");
          }

          const data = await response.json();

          // Remove all bot entries for this company from the UI
          const phoneEntries = Array.from(botStatuses.entries()).filter(
            ([key]) => key.startsWith(botName + "_")
          );

          phoneEntries.forEach(([key]) => {
            botStatuses.delete(key);
          });

          // Remove from bot activity map
          botActivityMap.delete(botName);

          // Re-render the status page
          renderStatuses();
          updateStats();

          // Show success notification
          showNotification(`âœ… Company ${botName} deleted successfully`, false);

          // Reload the page after a delay to refresh all data
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } catch (error) {
          console.error("Error deleting company:", error);
          showNotification(
            `âŒ Failed to delete company: ${error.message}`,
            true
          );
        }
      }

      function showNotification(message, isError = false) {
        // Remove any existing notifications
        const existingNotification = document.querySelector(".notification");
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create and show new notification
        const notification = document.createElement("div");
        notification.className = "notification";
        notification.style.background = isError ? "#dc2626" : "#059669";
        notification.textContent = message;
        document.body.appendChild(notification);

        // Remove notification after animation
        setTimeout(() => {
          notification.remove();
        }, 2500);
      }
      async function initializeAutomations() {
        try {
          const button = document.getElementById("initAutomationsButton");
          button.disabled = true;

          // Add rotation animation to the SVG while processing
          const svg = button.querySelector("svg");
          svg.style.animation = "spin 1s linear infinite";

          const response = await fetch("/api/initialize-automations", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (response.ok) {
            alert("Automations initialized successfully");
          } else {
            throw new Error(data.error || "Failed to initialize automations");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error initializing automations: " + error.message);
        } finally {
          const button = document.getElementById("initAutomationsButton");
          button.disabled = false;
          const svg = button.querySelector("svg");
          svg.style.animation = "";
        }
      }
      // Add debug function to check bot statuses
      function debugBotStatuses() {
        console.log("=== DEBUG: Current Bot Statuses ===");
        console.log("Total bot entries:", botStatuses.size);

        const statusCounts = {};
        const initializingBots = [];

        Array.from(botStatuses.entries()).forEach(([key, data]) => {
          const status = data.status;
          statusCounts[status] = (statusCounts[status] || 0) + 1;

          if (status.toLowerCase().includes("initializing")) {
            initializingBots.push({ key, status, data });
          }
        });

        console.log("Status counts:", statusCounts);
        console.log("Initializing bots:", initializingBots);

        // Show notification with debug info
        const debugInfo = `Total: ${botStatuses.size}, Initializing: ${initializingBots.length}`;
        showNotification(`Debug: ${debugInfo}`);
      }

      async function reinitializeAllPending() {
        const button = document.getElementById("refreshButton");
        button.classList.add("loading");

        try {
          // Debug: Log all current bot statuses
          console.log(
            "Current bot statuses:",
            Array.from(botStatuses.entries())
          );

          // Find all bots in initializing state (check multiple variations)
          const initializingBots = Array.from(botStatuses.entries())
            .filter(([, data]) => {
              const status = data.status.toLowerCase();
              const isInitializing =
                status === "initializing" ||
                status === "Initializing".toLowerCase() ||
                status.includes("initializing");

              if (isInitializing) {
                console.log(
                  `Found initializing bot: ${data.status} for key ${
                    data.botName || "unknown"
                  }`
                );
              }

              return isInitializing;
            })
            .map(([key]) => key.split("_")[0]);

          // Also check for bots in error or disconnected states that might need reinitialization
          const stuckBots = Array.from(botStatuses.entries())
            .filter(([, data]) => {
              const status = data.status.toLowerCase();
              const isStuck =
                status === "error" ||
                status === "disconnected" ||
                status.includes("error") ||
                status.includes("disconnected");

              if (isStuck) {
                console.log(
                  `Found stuck bot: ${data.status} for key ${
                    data.botName || "unknown"
                  }`
                );
              }

              return isStuck;
            })
            .map(([key]) => key.split("_")[0]);

          // Remove duplicates (in case multiple phones are initializing)
          const uniqueInitializingBots = [...new Set(initializingBots)];
          const uniqueStuckBots = [...new Set(stuckBots)];

          console.log("Found initializing bots:", uniqueInitializingBots);
          console.log("Found stuck bots:", uniqueStuckBots);

          // Combine both lists, prioritizing initializing bots
          const allBotsToReinitialize = [
            ...new Set([...uniqueInitializingBots, ...uniqueStuckBots]),
          ];

          if (allBotsToReinitialize.length === 0) {
            showNotification("No bots in initializing or stuck state");
            button.classList.remove("loading");
            return;
          }

          const initializingCount = uniqueInitializingBots.length;
          const stuckCount = uniqueStuckBots.length;

          showNotification(
            `Reinitializing ${allBotsToReinitialize.length} bot(s) - ${initializingCount} initializing, ${stuckCount} stuck`
          );

          // Reinitialize each bot
          let successCount = 0;
          let errorCount = 0;

          for (const botName of allBotsToReinitialize) {
            try {
              console.log(`Attempting to reinitialize bot: ${botName}`);

              const response = await fetch("/api/bots/reinitialize", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ botName }),
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(
                  errorData.error || `Failed to reinitialize ${botName}`
                );
              }

              const result = await response.json();
              console.log(`Reinitialize response for ${botName}:`, result);

              successCount++;
              console.log(`Successfully reinitialized ${botName}`);
            } catch (error) {
              console.error(`Error reinitializing ${botName}:`, error);
              showNotification(
                `Failed to reinitialize ${botName}: ${error.message}`,
                true
              );
              errorCount++;
            }
          }

          // Show final notification
          if (errorCount === 0) {
            showNotification(
              `Successfully reinitialized ${successCount} bot(s)`
            );
          } else if (successCount === 0) {
            showNotification(`Failed to reinitialize any bots`, true);
          } else {
            showNotification(
              `Reinitialized ${successCount} bot(s), ${errorCount} failed`,
              true
            );
          }
        } catch (error) {
          console.error("Error in reinitializeAllPending:", error);
          showNotification("An error occurred while reinitializing bots", true);
        } finally {
          button.classList.remove("loading");
        }
      }

      async function cleanupAllJobs() {
        if (
          !confirm(
            "Are you sure you want to clean up all problematic jobs? This will remove all pending jobs from the queue."
          )
        ) {
          return;
        }

        try {
          const button = document.getElementById("cleanupJobsButton");
          button.disabled = true;
          button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                    Cleaning...
                `;

          showNotification("Cleaning up problematic jobs...");

          const response = await fetch("/api/cleanup-jobs", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to clean up jobs");
          }

          showNotification("All problematic jobs cleaned up successfully!");

          // Optionally refresh the page or reinitialize bots
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (error) {
          console.error("Error cleaning up jobs:", error);
          showNotification("Failed to clean up jobs: " + error.message, true);
        } finally {
          const button = document.getElementById("cleanupJobsButton");
          button.disabled = false;
          button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                    Cleanup Jobs
                `;
        }
      }

      document
        .getElementById("initAutomationsButton")
        .addEventListener("click", async () => {
          try {
            const button = document.getElementById("initAutomationsButton");
            button.disabled = true;
            button.textContent = "Initializing...";

            const response = await fetch("/api/initialize-automations", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const data = await response.json();

            if (response.ok) {
              alert("Automations initialized successfully");
            } else {
              throw new Error(data.error || "Failed to initialize automations");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error initializing automations: " + error.message);
          } finally {
            const button = document.getElementById("initAutomationsButton");
            button.disabled = false;
            button.textContent = "Initialize Automations";
          }
        });

      async function deleteTrialEndDate(botName) {
        if (
          !confirm(
            `Are you sure you want to delete the trial period for ${botName}?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/api/bots/${botName}/trial-end-date`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error("Failed to delete trial end date");
          }

          // Show success notification
          showNotification(`Trial period deleted for ${botName}`);

          // Refresh the bot data
          await initializeBots();
        } catch (error) {
          console.error("Error deleting trial end date:", error);
          showNotification("Failed to delete trial period", true);
        }
      }

      // Update the category update function to handle single bot updates
      async function updateBotCategory(botId, newCategory) {
        if (!newCategory) return;

        try {
          const response = await fetch(`/api/bots/${botId}/category`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ category: newCategory }),
          });

          if (!response.ok) {
            throw new Error(`Failed to update category for bot ${botId}`);
          }

          // Show success notification
          showNotification(`Bot moved to ${newCategory} category`);

          // Refresh the bot data and re-render
          await initializeBots();
        } catch (error) {
          console.error("Error updating category:", error);
          showNotification("Failed to update category", true);
        }
      }

      // Add event listener to the "Currently Active" stat card
      document
        .getElementById("currentlyActiveBots")
        .parentElement.addEventListener("click", toggleActiveBots);

      let showingOnlyActive = false;

      function toggleActiveBots() {
        const botItems = document.querySelectorAll(".bot-item");
        showingOnlyActive = !showingOnlyActive;

        botItems.forEach((item) => {
          const isActive = item.querySelector(".bot-activity") !== null;

          if (showingOnlyActive) {
            item.classList.toggle("hidden", !isActive);
          } else {
            item.classList.remove("hidden");
          }
        });

        updateFilteredStats();
      }

      // ============================================
      // AUTO-REPLY MANAGEMENT FUNCTIONS
      // ============================================

      // Test auto-reply on specific phone number
      async function testAutoReply() {
        const companyId = document.getElementById("testCompanySelect").value;
        const phoneNumber = document.getElementById("testPhoneNumber").value;
        const hoursThreshold = document.getElementById("testHoursSelect").value;

        if (!companyId) {
          showNotification("Please select a company", true);
          return;
        }

        if (!phoneNumber) {
          showNotification("Please enter a phone number", true);
          return;
        }

        const button = document.getElementById("testAutoReplyButton");
        button.disabled = true;
        button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                </svg>
                Testing...
            `;

        try {
          showNotification(
            `Testing auto-reply for ${phoneNumber} in company ${companyId}...`
          );

          const response = await fetch(`/api/auto-reply/test/${companyId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              phoneNumber: phoneNumber,
              hoursThreshold: parseInt(hoursThreshold),
            }),
          });

          const data = await response.json();

          if (data.success) {
            showNotification(`âœ… Test completed: ${data.message}`);
          } else {
            showNotification(
              `âŒ Test failed: ${data.error || data.message}`,
              true
            );
          }
        } catch (error) {
          console.error("Error testing auto-reply:", error);
          showNotification("âŒ Test failed: Network error", true);
        } finally {
          button.disabled = false;
          button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 12l2 2 4-4"/>
                        <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.35 0 4.48.9 6.08 2.38l.94-.94"/>
                    </svg>
                    Test Auto-Reply
                `;
        }
      }

      // Trigger auto-reply check for a specific company
      async function triggerAutoReply(companyId) {
        console.log(`Triggering auto-reply for company: ${companyId}`);

        // Find the button that was clicked to update its state
        const buttons = document.querySelectorAll(
          `button[onclick*="triggerAutoReply('${companyId}')"]`
        );
        const checkButton = buttons[0]; // Get the first matching button

        if (checkButton) {
          // Update button to show running state
          checkButton.disabled = true;
          checkButton.textContent = "Running...";
          checkButton.style.background = "#f59e0b";
        }

        try {
          showNotification(
            `Starting auto-reply check for company ${companyId}...`
          );

          const response = await fetch(`/api/auto-reply/trigger/${companyId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              hoursThreshold: 12, // Default 12 hours
            }),
          });

          const data = await response.json();

          if (data.success) {
            showNotification(
              `âœ… ${data.message} (${data.count}/${data.total} messages processed)`
            );
            console.log("Auto-reply result:", data);
          } else {
            showNotification(
              `âŒ Auto-reply failed: ${data.error || data.message}`,
              true
            );
          }
        } catch (error) {
          console.error("Error triggering auto-reply:", error);
          showNotification("âŒ Auto-reply failed: Network error", true);
        } finally {
          // Reset button
          if (checkButton) {
            checkButton.disabled = false;
            checkButton.textContent = "Auto-Reply Check";
            checkButton.style.background = "#059669";
          }
        }
      }

      // Show unreplied messages for a company
      async function showUnrepliedMessages(companyId) {
        try {
          showNotification(
            `Fetching unreplied messages for company ${companyId}...`
          );

          const response = await fetch(
            `/api/auto-reply/unreplied/${companyId}?hoursThreshold=24`
          );
          const data = await response.json();

          if (data.success) {
            if (data.data.count === 0) {
              showNotification(
                `âœ… No unreplied messages found for company ${companyId}`
              );
            } else {
              // Create a modal to show unreplied messages
              showUnrepliedMessagesModal(companyId, data.data);
            }
          } else {
            showNotification(
              `âŒ Failed to fetch unreplied messages: ${data.error}`,
              true
            );
          }
        } catch (error) {
          console.error("Error fetching unreplied messages:", error);
          showNotification(
            "âŒ Failed to fetch unreplied messages: Network error",
            true
          );
        }
      }

      // Show modal with unreplied messages
      function showUnrepliedMessagesModal(companyId, data) {
        // Create modal
        const modal = document.createElement("div");
        modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.95);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

        const modalContent = document.createElement("div");
        modalContent.style.cssText = `
                background: #1e293b;
                padding: 2rem;
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 80%;
                overflow-y: auto;
                text-align: left;
            `;

        modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0; color: #f8fafc;">Unreplied Messages - Company ${companyId}</h2>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="showReplyToAllConfirmation('${companyId}', ${JSON.stringify(
          data.messages
        ).replace(/"/g, "&quot;")})" style="
                            background: #059669;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                        ">Reply to All</button>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" style="
                            background: #ef4444;
                            color: white;
                            border: none;
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
                <p style="color: #94a3b8; margin-bottom: 1rem;">Found ${
                  data.count
                } unreplied messages in the last 12 hours:</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${data.messages
                      .map(
                        (msg, index) => `
                        <div style="
                            background: #0f172a;
                            border: 1px solid #475569;
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 8px;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="msg-${index}" checked style="
                                        width: 16px;
                                        height: 16px;
                                        accent-color: #3b82f6;
                                    ">
                                    <label for="msg-${index}" style="
                                        color: #f8fafc;
                                        font-weight: 500;
                                        cursor: pointer;
                                        margin: 0;
                                    ">${msg.phone}</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <small style="color: #94a3b8;">${new Date(
                                      msg.messageTime
                                    ).toLocaleString()}</small>
                                    <button onclick="replyToSingleMessage('${companyId}', '${
                          msg.phone
                        }', ${index})" style="
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        padding: 4px 8px;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        font-weight: 500;
                                    ">Reply Now</button>
                                </div>
                            </div>
                            <div style="color: #e2e8f0; margin-bottom: 4px;">${
                              msg.content
                            }</div>
                            <small style="color: #64748b;">
                                Last reply: ${
                                  msg.lastReplyTime
                                    ? new Date(
                                        msg.lastReplyTime
                                      ).toLocaleString()
                                    : "Never"
                                }
                            </small>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Auto-close notification after showing modal
        setTimeout(() => {
          showNotification(`ðŸ“‹ Showing ${data.count} unreplied messages`);
        }, 500);
      }

      // Show confirmation dialog for replying to all selected messages
      function showReplyToAllConfirmation(companyId, messages) {
        // Get selected messages
        const selectedMessages = [];
        const unselectedMessages = [];

        messages.forEach((msg, index) => {
          const checkbox = document.getElementById(`msg-${index}`);
          if (checkbox && checkbox.checked) {
            selectedMessages.push(msg);
          } else {
            unselectedMessages.push(msg);
          }
        });

        if (selectedMessages.length === 0) {
          showNotification(
            "âŒ Please select at least one message to reply to",
            true
          );
          return;
        }

        // Create confirmation modal
        const confirmModal = document.createElement("div");
        confirmModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.95);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;

        const confirmContent = document.createElement("div");
        confirmContent.style.cssText = `
                background: #1e293b;
                padding: 2rem;
                border-radius: 12px;
                width: 90%;
                max-width: 600px;
                max-height: 80%;
                overflow-y: auto;
                text-align: left;
            `;

        const selectedCount = selectedMessages.length;
        const totalCount = messages.length;
        const unselectedCount = unselectedMessages.length;

        confirmContent.innerHTML = `
                <h3 style="color: #f8fafc; margin-bottom: 1rem;">Confirm Auto-Reply</h3>
                
                <div style="background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <p style="color: #e2e8f0; margin-bottom: 12px;">
                        You are about to send auto-replies to <strong style="color: #10b981;">${selectedCount}</strong> out of ${totalCount} messages.
                    </p>
                    
                    ${
                      unselectedCount > 0
                        ? `
                        <p style="color: #f59e0b; font-size: 14px;">
                            âš ï¸ ${unselectedCount} message(s) will be skipped (unchecked).
                        </p>
                    `
                        : ""
                    }
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #f8fafc; margin-bottom: 8px;">Selected Messages:</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${selectedMessages
                          .map(
                            (msg, index) => `
                            <div style="
                                background: #0f172a;
                                border: 1px solid #475569;
                                border-radius: 6px;
                                padding: 8px;
                                margin-bottom: 6px;
                                font-size: 13px;
                            ">
                                <div style="color: #f8fafc; font-weight: 500; margin-bottom: 4px;">${
                                  msg.phone
                                }</div>
                                <div style="color: #94a3b8; font-size: 12px;">${msg.content.substring(
                                  0,
                                  60
                                )}${msg.content.length > 60 ? "..." : ""}</div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: #6b7280;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    ">Cancel</button>
                    <button onclick="confirmReplyToAll('${companyId}', ${JSON.stringify(
          selectedMessages
        ).replace(/"/g, "&quot;")})" style="
                        background: #059669;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                    ">Send Auto-Replies (${selectedCount})</button>
                </div>
            `;

        confirmModal.appendChild(confirmContent);
        document.body.appendChild(confirmModal);
      }

      // Confirm and execute replying to all selected messages
      async function confirmReplyToAll(companyId, selectedMessages) {
        // Remove the confirmation modal
        const confirmModal = document.querySelector(
          'div[style*="z-index: 2000"]'
        );
        if (confirmModal) {
          confirmModal.remove();
        }

        console.log(
          `Replying to ${selectedMessages.length} selected messages for company: ${companyId}`
        );

        try {
          showNotification(
            `ðŸš€ Starting auto-reply for ${selectedMessages.length} selected messages in company ${companyId}...`
          );

          // Process each selected message individually
          let successCount = 0;
          let errorCount = 0;

          for (const message of selectedMessages) {
            try {
              const response = await fetch(
                `/api/auto-reply/test/${companyId}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    phoneNumber: message.phone,
                    hoursThreshold: 12,
                  }),
                }
              );

              const data = await response.json();

              if (data.success) {
                successCount++;
                console.log(`Successfully sent auto-reply to ${message.phone}`);
              } else {
                errorCount++;
                console.error(
                  `Failed to send auto-reply to ${message.phone}:`,
                  data.error
                );
              }
            } catch (error) {
              errorCount++;
              console.error(
                `Error sending auto-reply to ${message.phone}:`,
                error
              );
            }
          }

          // Show final result
          if (errorCount === 0) {
            showNotification(
              `âœ… Successfully sent auto-replies to all ${successCount} messages!`
            );
          } else if (successCount === 0) {
            showNotification(
              `âŒ Failed to send any auto-replies (${errorCount} errors)`,
              true
            );
          } else {
            showNotification(
              `âš ï¸ Sent ${successCount} auto-replies, ${errorCount} failed`,
              true
            );
          }

          // Close the main modal after a delay
          setTimeout(() => {
            const mainModal = document.querySelector(
              'div[style*="z-index: 1000"]'
            );
            if (mainModal) {
              mainModal.remove();
            }
          }, 2000);
        } catch (error) {
          console.error("Error in confirmReplyToAll:", error);
          showNotification(
            `âŒ Failed to process auto-replies: ${error.message}`,
            true
          );
        }
      }

      // Update auto-reply status on page load
      async function updateAutoReplyStatus() {
        // Get unique company IDs from bot data
        const companies = [
          ...new Set(
            window.botsData
              ?.map((bot) => bot.companyId || bot.botName)
              .filter(Boolean) || []
          ),
        ];

        for (const companyId of companies) {
          try {
            const response = await fetch(`/api/auto-reply/status/${companyId}`);
            const data = await response.json();

            if (data.success) {
              // Since we're not using company cards anymore, we could store this data for display elsewhere
              console.log(`Auto-reply status for ${companyId}:`, data.data);
            }
          } catch (error) {
            console.error(
              `Error fetching status for company ${companyId}:`,
              error
            );
          }
        }
      }

      // ============================================
      // END AUTO-REPLY MANAGEMENT FUNCTIONS
      // ============================================

      // ============================================
      // INDIVIDUAL REPLY FUNCTIONS
      // ============================================

      // Reply to a single message
      async function replyToSingleMessage(
        companyId,
        phoneNumber,
        messageIndex
      ) {
        console.log(
          `Replying to single message from ${phoneNumber} in company ${companyId}`
        );

        try {
          showNotification(`ðŸš€ Sending auto-reply to ${phoneNumber}...`);

          const response = await fetch(`/api/auto-reply/test/${companyId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              phoneNumber: phoneNumber,
              hoursThreshold: 12,
            }),
          });

          const data = await response.json();

          if (data.success) {
            showNotification(
              `âœ… Auto-reply sent to ${phoneNumber}: ${data.message}`,
              false
            );
            console.log("Single reply response:", data);

            // Update the button to show it was sent
            const buttons = document.querySelectorAll(
              `button[onclick*="replyToSingleMessage('${companyId}', '${phoneNumber}', ${messageIndex})"]`
            );
            if (buttons.length > 0) {
              const button = buttons[0];
              button.textContent = "Sent âœ“";
              button.style.background = "#10b981";
              button.disabled = true;
            }
          } else {
            showNotification(
              `âŒ Error replying to ${phoneNumber}: ${data.error}`,
              true
            );
          }
        } catch (error) {
          console.error("Error sending single reply:", error);
          showNotification(
            `âŒ Failed to reply to ${phoneNumber}: ${error.message}`,
            true
          );
        }
      }

      initialize();

      // Populate test company select with dynamic companies
      function populateTestCompanySelect() {
        const select = document.getElementById("testCompanySelect");
        if (!select || !window.botsData) return;

        // Get unique company IDs from bot data
        const companies = [
          ...new Set(
            window.botsData
              .map((bot) => bot.companyId || bot.botName)
              .filter(Boolean)
          ),
        ];

        // Clear existing options except the first one
        while (select.children.length > 1) {
          select.removeChild(select.lastChild);
        }

        // Add company options
        companies.forEach((companyId) => {
          const option = document.createElement("option");
          option.value = companyId;
          option.textContent = `Company ${companyId}`;
          select.appendChild(option);
        });
      }

      // ============================================
    </script>
  </body>
</html>

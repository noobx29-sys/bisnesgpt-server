<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bot Status Monitor</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root {
        --orange: #E8600A;
        --orange-light: #F28A3C;
        --orange-bg: #FFF5EE;
        --orange-100: #FEE8D6;
        --green: #16A34A;
        --green-bg: #F0FDF4;
        --red: #DC2626;
        --red-bg: #FEF2F2;
        --blue: #2563EB;
        --blue-bg: #EFF6FF;
        --purple: #7C3AED;
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        --radius: 10px;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        background: var(--gray-50);
        color: var(--gray-800);
        font-family: 'Inter', -apple-system, sans-serif;
        line-height: 1.5;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }

      .container { max-width: 1320px; margin: 0 auto; padding: 20px 24px; }

      /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
      .header {
        background: #fff;
        border: 1px solid var(--gray-200);
        padding: 16px 24px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
      }
      .header h1 {
        font-size: 20px;
        font-weight: 800;
        color: var(--orange);
        letter-spacing: -0.3px;
      }
      .header-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
      .hdr-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 7px 12px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 7px;
        border: 1px solid var(--gray-200);
        background: #fff;
        color: var(--gray-700);
        cursor: pointer;
        transition: all .15s;
        white-space: nowrap;
      }
      .hdr-btn:hover { background: var(--gray-50); border-color: var(--gray-300); }
      .hdr-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
      .hdr-btn.primary { background: var(--orange); color: #fff; border-color: var(--orange); }
      .hdr-btn.primary:hover { background: var(--orange-light); }
      .hdr-btn.green { background: var(--green); color: #fff; border-color: var(--green); }
      .hdr-btn.green:hover { opacity: .9; }

      /* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
      .stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px; }
      @media (max-width: 900px) { .stats { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 600px) { .stats { grid-template-columns: repeat(2, 1fr); } }
      .stat-card {
        background: #fff;
        border: 1px solid var(--gray-200);
        padding: 14px 16px;
        border-radius: var(--radius);
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: all .2s;
      }
      .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
      .stat-value { font-size: 28px; font-weight: 800; color: var(--orange); line-height: 1.2; }
      .stat-label { font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: .5px; margin-top: 2px; }
      .stat-card.accent-blue .stat-value { color: var(--blue); }
      .stat-card.accent-green .stat-value { color: var(--green); }

      /* ‚îÄ‚îÄ‚îÄ Process Health ‚îÄ‚îÄ‚îÄ */
      .proc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
      @media (max-width: 700px) { .proc-grid { grid-template-columns: 1fr; } }
      .proc-card {
        background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius);
        padding: 14px 16px; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 6px;
      }
      .proc-card-header { display: flex; justify-content: space-between; align-items: center; }
      .proc-name { font-size: 13px; font-weight: 700; color: var(--gray-700); display: flex; align-items: center; gap: 7px; }
      .proc-dot { width: 9px; height: 9px; border-radius: 50%; background: var(--gray-300); flex-shrink: 0; }
      .proc-dot.healthy { background: var(--green); animation: pulse 2s infinite; }
      .proc-dot.down { background: var(--red); }
      .proc-badge { padding: 2px 9px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
      .proc-badge.healthy { background: var(--green-bg); color: var(--green); border: 1px solid #BBF7D0; }
      .proc-badge.down { background: var(--red-bg); color: var(--red); border: 1px solid #FECACA; }
      .proc-badge.unknown { background: var(--gray-100); color: var(--gray-500); border: 1px solid var(--gray-200); }
      .proc-detail { font-size: 11px; color: var(--gray-500); }
      .proc-detail b { color: var(--gray-700); }
      .proc-port { font-size: 10px; font-family: monospace; color: var(--gray-400); }

      /* ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ */
      .search-bar {
        width: 100%;
        padding: 10px 14px;
        font-size: 13px;
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        color: var(--gray-800);
        margin-bottom: 16px;
        transition: all .15s;
        box-shadow: var(--shadow-sm);
      }
      .search-bar:focus { outline: none; border-color: var(--orange); box-shadow: 0 0 0 3px var(--orange-100); }
      .search-bar::placeholder { color: var(--gray-400); }

      /* ‚îÄ‚îÄ‚îÄ Auto-Reply Section ‚îÄ‚îÄ‚îÄ */
      .ar-section {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        padding: 16px 20px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        border-left: 3px solid var(--orange);
      }
      .ar-section h3 { font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 10px; }
      .ar-section h3 span { color: var(--orange); }
      .ar-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .ar-select, .ar-input {
        padding: 8px 12px; font-size: 13px;
        border: 1px solid var(--gray-200); border-radius: 7px;
        color: var(--gray-800); background: #fff; transition: all .15s;
      }
      .ar-select:focus, .ar-input:focus { outline: none; border-color: var(--orange); box-shadow: 0 0 0 3px var(--orange-100); }
      .ar-input { width: 200px; }
      .ar-btn {
        padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 7px;
        border: none; background: var(--orange); color: #fff;
        cursor: pointer; transition: all .15s; display: inline-flex; align-items: center; gap: 5px;
      }
      .ar-btn:hover { background: var(--orange-light); }
      .ar-btn:disabled { opacity: .6; cursor: not-allowed; }
      .ar-result { margin-top: 12px; padding: 12px; border-radius: 7px; font-size: 13px; display: none; }
      .ar-result.success { background: var(--green-bg); border: 1px solid #BBF7D0; color: #166534; display: block; }
      .ar-result.error { background: var(--red-bg); border: 1px solid #FECACA; color: #991B1B; display: block; }
      .ar-result .detail-grid { display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; margin-top: 8px; font-size: 12px; }
      .ar-result .detail-label { font-weight: 600; color: var(--gray-600); }
      .ar-result .detail-value { color: var(--gray-700); }

      /* ‚îÄ‚îÄ‚îÄ Company Management ‚îÄ‚îÄ‚îÄ */
      .mgmt-section {
        background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius);
        padding: 16px 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm);
      }
      .mgmt-section h3 { font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
      .badge-count { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; background: var(--orange-100); color: var(--orange); }
      .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; min-height: 32px; padding: 10px; background: var(--gray-50); border-radius: 7px; border: 1px solid var(--gray-100); }
      .tag-item { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: var(--orange-bg); border: 1px solid var(--orange-100); border-radius: 5px; font-size: 12px; font-weight: 600; color: var(--orange); font-family: monospace; }
      .tag-remove { width: 16px; height: 16px; padding: 0; background: none; border: none; color: var(--red); font-size: 14px; font-weight: bold; cursor: pointer; line-height: 1; border-radius: 3px; transition: all .1s; }
      .tag-remove:hover { background: var(--red-bg); }
      .mgmt-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .mgmt-select { padding: 8px 12px; background: #fff; border: 1px solid var(--gray-200); border-radius: 7px; font-size: 13px; color: var(--gray-800); min-width: 220px; }
      .mgmt-select:focus { outline: none; border-color: var(--orange); }
      .mgmt-btn { padding: 8px 14px; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all .15s; border: 1px solid var(--gray-200); background: #fff; color: var(--gray-700); }
      .mgmt-btn:hover { background: var(--gray-50); }
      .mgmt-btn.add { background: var(--orange); color: #fff; border-color: var(--orange); }
      .mgmt-btn.add:hover { background: var(--orange-light); }
      .mgmt-note { color: var(--gray-400); font-size: 11px; margin-top: 10px; }

      /* ‚îÄ‚îÄ‚îÄ Bot List ‚îÄ‚îÄ‚îÄ */
      .bot-list {
        background: #fff; border: 1px solid var(--gray-200); border-radius: var(--radius);
        overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 20px;
      }
      .bot-list-header {
        display: grid; grid-template-columns: 2fr 1fr 2fr; gap: 16px;
        padding: 10px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);
        font-size: 11px; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: .5px;
      }
      .bot-list-header span:nth-child(2) { text-align: center; }
      .bot-list-header span:nth-child(3) { text-align: right; }
      .bot-item {
        display: grid; grid-template-columns: 2fr 1fr 2fr; gap: 16px;
        padding: 12px 20px; border-bottom: 1px solid var(--gray-100);
        align-items: center; transition: background .1s;
      }
      .bot-item:last-child { border-bottom: none; }
      .bot-item:hover { background: var(--orange-bg); }
      .bot-item.hidden { display: none; }
      .bot-info { display: flex; flex-direction: column; gap: 3px; }
      .bot-display-name { font-size: 14px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
      .bot-id { font-size: 12px; color: var(--gray-400); font-family: monospace; }

      /* ‚îÄ‚îÄ‚îÄ Status Badges ‚îÄ‚îÄ‚îÄ */
      .bot-status { justify-self: center; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; white-space: nowrap; }
      .status-ready { background: var(--green-bg); color: var(--green); border: 1px solid #BBF7D0; }
      .status-connected { background: var(--green-bg); color: var(--green); border: 1px solid #BBF7D0; }
      .status-qr { background: #FFFBEB; color: #B45309; border: 1px solid #FDE68A; }
      .status-error { background: var(--red-bg); color: var(--red); border: 1px solid #FECACA; }
      .status-initializing { background: var(--blue-bg); color: var(--blue); border: 1px solid #BFDBFE; }
      .status-authenticated { background: #F5F3FF; color: var(--purple); border: 1px solid #DDD6FE; }
      .status-disconnected { background: var(--gray-100); color: var(--gray-500); border: 1px solid var(--gray-200); }
      .status-pending, .status-pending_review { background: #FFFBEB; color: #B45309; border: 1px solid #FDE68A; }

      /* ‚îÄ‚îÄ‚îÄ Badges ‚îÄ‚îÄ‚îÄ */
      .plan-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
      .plan-badge.enterprise { background: #EEF2FF; color: #4338CA; }
      .plan-badge.pro { background: #F5F3FF; color: #7C3AED; }
      .plan-badge.basic { background: var(--green-bg); color: var(--green); }
      .trial-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #FFFBEB; color: #B45309; }

      /* ‚îÄ‚îÄ‚îÄ Bot Actions ‚îÄ‚îÄ‚îÄ */
      .bot-actions { display: flex; gap: 5px; justify-content: flex-end; flex-wrap: wrap; }
      .bot-actions button { padding: 5px 10px; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all .15s; white-space: nowrap; }
      .bot-actions button:hover { opacity: .85; transform: translateY(-1px); }
      .reinit-button { background: var(--blue); color: #fff; }
      .disconnect-button { background: var(--orange); color: #fff; }
      .delete-trial-button { background: var(--red); color: #fff; }
      .delete-company-button { background: #7F1D1D; color: #fff; }
      .view-unreplied-btn { background: var(--orange); color: #fff; }

      /* ‚îÄ‚îÄ‚îÄ Activity ‚îÄ‚îÄ‚îÄ */
      .bot-activity { display: inline-flex; align-items: center; gap: 5px; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; background: var(--green-bg); color: var(--green); border: 1px solid #BBF7D0; }
      .bot-activity .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
      @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }

      /* ‚îÄ‚îÄ‚îÄ Meta Info ‚îÄ‚îÄ‚îÄ */
      .meta-verification-info { margin-top: 4px; padding: 6px 10px; background: var(--blue-bg); border: 1px solid #BFDBFE; border-radius: 6px; font-size: 11px; }
      .meta-verification-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
      .meta-verification-row:last-child { margin-bottom: 0; }
      .meta-label { color: var(--gray-500); font-weight: 500; }
      .meta-value { color: var(--gray-700); font-weight: 600; }
      .meta-verified-badge { display: inline-flex; align-items: center; gap: 3px; padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; background: var(--green-bg); color: var(--green); border: 1px solid #BBF7D0; }
      .meta-verified-badge svg { width: 10px; height: 10px; }
      .meta-quality-badge { padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
      .meta-quality-GREEN { background: var(--green-bg); color: var(--green); }
      .meta-quality-YELLOW { background: #FFFBEB; color: #B45309; }
      .meta-quality-RED { background: var(--red-bg); color: var(--red); }
      .meta-connection-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-left: 6px; }
      .meta-type-meta_direct { background: var(--blue-bg); color: var(--blue); }
      .meta-type-meta_embedded { background: #F5F3FF; color: var(--purple); }
      .meta-type-360dialog { background: #FFFBEB; color: #B45309; }
      .verify-meta-btn { padding: 3px 8px; font-size: 10px; font-weight: 600; background: var(--blue); color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: all .15s; }
      .verify-meta-btn:hover { opacity: .85; }
      .verify-meta-btn:disabled { opacity: .4; cursor: not-allowed; }

      /* ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ */
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn .15s ease; }
      .modal-overlay.z2 { z-index: 2000; }
      .modal-box { background: #fff; border-radius: 12px; width: 90%; max-width: 720px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalIn .2s ease; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--gray-200); position: sticky; top: 0; background: #fff; z-index: 1; }
      .modal-header h2 { font-size: 16px; font-weight: 800; color: var(--gray-800); }
      .modal-header-actions { display: flex; gap: 6px; }
      .modal-btn { padding: 6px 14px; border-radius: 7px; font-size: 12px; font-weight: 700; border: none; cursor: pointer; transition: all .15s; }
      .modal-btn.green { background: var(--green); color: #fff; }
      .modal-btn.green:hover { opacity: .85; }
      .modal-btn.red { background: var(--red); color: #fff; }
      .modal-btn.gray { background: var(--gray-200); color: var(--gray-700); }
      .modal-btn.gray:hover { background: var(--gray-300); }
      .modal-btn.orange { background: var(--orange); color: #fff; }
      .modal-btn.orange:hover { background: var(--orange-light); }
      .modal-body { padding: 16px 20px; }
      .modal-subtitle { font-size: 13px; color: var(--gray-500); margin-bottom: 12px; }

      /* ‚îÄ‚îÄ‚îÄ Message Cards ‚îÄ‚îÄ‚îÄ */
      .msg-card { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; transition: all .1s; }
      .msg-card:hover { border-color: var(--orange-100); background: var(--orange-bg); }
      .msg-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
      .msg-phone-row { display: flex; align-items: center; gap: 8px; }
      .msg-phone-row input[type="checkbox"] { width: 15px; height: 15px; accent-color: var(--orange); cursor: pointer; }
      .msg-phone-row label { font-size: 13px; font-weight: 700; color: var(--gray-800); cursor: pointer; }
      .msg-actions { display: flex; align-items: center; gap: 8px; }
      .msg-time { font-size: 11px; color: var(--gray-400); }
      .msg-reply-btn { padding: 3px 10px; border-radius: 5px; font-size: 11px; font-weight: 700; background: var(--orange); color: #fff; border: none; cursor: pointer; transition: all .15s; }
      .msg-reply-btn:hover { background: var(--orange-light); }
      .msg-reply-btn:disabled { opacity: .5; cursor: not-allowed; }
      .msg-content { font-size: 13px; color: var(--gray-700); margin-bottom: 4px; word-break: break-word; }
      .msg-meta { font-size: 11px; color: var(--gray-400); }

      /* ‚îÄ‚îÄ‚îÄ Notification ‚îÄ‚îÄ‚îÄ */
      .notification { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.15); animation: notifIn .2s ease, fadeOut .4s ease 2.5s forwards; z-index: 10000; max-width: 90vw; text-align: center; }

      /* ‚îÄ‚îÄ‚îÄ Connection Status ‚îÄ‚îÄ‚îÄ */
      .connection-status { position: fixed; bottom: 20px; right: 20px; padding: 8px 14px; border-radius: 7px; background: #fff; border: 1px solid var(--gray-200); font-size: 12px; font-weight: 600; color: var(--gray-600); box-shadow: var(--shadow-md); display: none; z-index: 1000; }

      /* ‚îÄ‚îÄ‚îÄ Password ‚îÄ‚îÄ‚îÄ */
      .pw-overlay { position: fixed; inset: 0; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 9999; }
      .pw-box { padding: 40px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--gray-200); box-shadow: var(--shadow-md); }
      .pw-box h2 { font-size: 22px; font-weight: 800; color: var(--orange); margin-bottom: 24px; }
      .pw-input { width: 100%; padding: 12px 16px; margin-bottom: 16px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px; color: var(--gray-800); }
      .pw-input:focus { outline: none; border-color: var(--orange); box-shadow: 0 0 0 3px var(--orange-100); }
      .pw-submit { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--orange); color: #fff; font-size: 15px; font-weight: 700; cursor: pointer; transition: all .15s; }
      .pw-submit:hover { background: var(--orange-light); }

      .no-results { text-align: center; padding: 20px; color: var(--gray-400); font-size: 13px; }

      /* ‚îÄ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ */
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes modalIn { from { opacity: 0; transform: scale(.96) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
      @keyframes notifIn { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
      @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      @media (max-width: 768px) {
        .header { flex-direction: column; align-items: flex-start; }
        .header-buttons { width: 100%; flex-wrap: wrap; }
        .bot-item { grid-template-columns: 1fr; gap: 8px; }
        .bot-list-header { display: none; }
        .bot-actions { justify-content: flex-start; }
        .bot-status { justify-self: start; }
        .ar-controls { flex-direction: column; align-items: stretch; }
        .ar-input { width: 100%; }
      }
    </style>
  </head>
  <body>
    <!-- Password Gate -->
    <div id="passwordModal" class="pw-overlay">
      <div class="pw-box">
        <h2>üîê Bot Status Monitor</h2>
        <input type="password" id="passwordInput" class="pw-input" placeholder="Enter password" />
        <button onclick="checkPassword()" class="pw-submit">Sign In</button>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none">
      <div class="container">
        <!-- Header -->
        <div class="header">
          <h1>Bot Status Monitor</h1>
          <div class="header-buttons">
            <button onclick="window.location.href='/logs'" class="hdr-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              Logs
            </button>
            <button onclick="debugBotStatuses()" class="hdr-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
              Debug
            </button>
            <button onclick="cleanupAllJobs()" class="hdr-btn" id="cleanupJobsButton">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Cleanup
            </button>
            <button onclick="initializeAutomations()" class="hdr-btn" id="initAutomationsButton">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
              Init Automations
            </button>
            <button onclick="reinitializeAllPending()" class="hdr-btn primary" id="refreshButton">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
              Reinit Pending
            </button>
            <button onclick="triggerHealthReport()" class="hdr-btn green" id="healthReportButton">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
              Health Report
            </button>
          </div>
        </div>

        <!-- Auto-Reply Test -->
        <div class="ar-section">
          <h3>‚ö° <span>Test Auto-Reply</span></h3>
          <div class="ar-controls">
            <select id="testCompanySelect" class="ar-select">
              <option value="">Select Company</option>
            </select>
            <input type="text" id="testPhoneNumber" placeholder="Phone (e.g., +601121677522)" value="+601121677522" class="ar-input" />
            <select id="testHoursSelect" class="ar-select">
              <option value="1">1 hour</option>
              <option value="6">6 hours</option>
              <option value="12">12 hours</option>
              <option value="24" selected>24 hours</option>
              <option value="48">48 hours</option>
            </select>
            <button onclick="testAutoReply()" class="ar-btn" id="testAutoReplyButton">
              Test Auto-Reply
            </button>
          </div>
          <div id="testAutoReplyResult" class="ar-result"></div>
        </div>

        <!-- Stats -->
        <div class="stats">
          <div class="stat-card"><div class="stat-value" id="totalBots">0</div><div class="stat-label">Total Bots</div></div>
          <div class="stat-card"><div class="stat-value" id="activeBots">0</div><div class="stat-label">Connected</div></div>
          <div class="stat-card accent-blue"><div class="stat-value" id="metaConnected">0</div><div class="stat-label">Meta API</div></div>
          <div class="stat-card accent-green"><div class="stat-value" id="wwebjsConnected">0</div><div class="stat-label">WWebJS</div></div>
          <div class="stat-card"><div class="stat-value" id="disconnectedBots">0</div><div class="stat-label">Disconnected</div></div>
          <div class="stat-card"><div class="stat-value" id="currentlyActiveBots">0</div><div class="stat-label">Active Now</div></div>
        </div>

        <!-- Process Health -->
        <div class="proc-grid">
          <div class="proc-card">
            <div class="proc-card-header">
              <div class="proc-name"><span class="proc-dot unknown" id="dot-api"></span>API Server</div>
              <span class="proc-badge unknown" id="badge-api">Checking</span>
            </div>
            <div class="proc-detail">Port <b>3000</b> &nbsp;¬∑&nbsp; <span class="proc-port">bisnesgpt-api</span></div>
            <div class="proc-detail">Uptime: <b id="uptime-api">‚Äî</b></div>
            <div class="proc-detail" id="info-api" style="color:var(--gray-400)">HTTP API &amp; routing</div>
          </div>
          <div class="proc-card">
            <div class="proc-card-header">
              <div class="proc-name"><span class="proc-dot unknown" id="dot-wwebjs"></span>WWebJS</div>
              <span class="proc-badge unknown" id="badge-wwebjs">Checking</span>
            </div>
            <div class="proc-detail">Port <b>3001</b> &nbsp;¬∑&nbsp; <span class="proc-port">bisnesgpt-wwebjs</span></div>
            <div class="proc-detail">Uptime: <b id="uptime-wwebjs">‚Äî</b></div>
            <div class="proc-detail" id="info-wwebjs" style="color:var(--gray-400)">WhatsApp Web (Puppeteer)</div>
          </div>
          <div class="proc-card">
            <div class="proc-card-header">
              <div class="proc-name"><span class="proc-dot unknown" id="dot-meta"></span>Meta Direct</div>
              <span class="proc-badge unknown" id="badge-meta">Checking</span>
            </div>
            <div class="proc-detail">Port <b>3002</b> &nbsp;¬∑&nbsp; <span class="proc-port">bisnesgpt-meta</span></div>
            <div class="proc-detail">Uptime: <b id="uptime-meta">‚Äî</b></div>
            <div class="proc-detail" id="info-meta" style="color:var(--gray-400)">Meta Cloud API</div>
          </div>
        </div>

        <!-- Search -->
        <input type="text" id="searchInput" placeholder="Search bots by name, ID, or status..." class="search-bar" />

        <!-- Company Management -->
        <div class="mgmt-section">
          <h3>üìã Monitored Companies <span id="companyCountBadge" class="badge-count">0</span></h3>
          <div id="monitoredCompaniesList" class="tag-list">
            <span style="color: var(--gray-400); font-style: italic; font-size: 12px;">Loading...</span>
          </div>
          <div class="mgmt-controls">
            <select id="addCompanySelect" class="mgmt-select"><option value="">Select a company to add...</option></select>
            <button onclick="handleAddCompany()" class="mgmt-btn add">+ Add Company</button>
            <button onclick="refreshMonitoredCompanies()" class="mgmt-btn">üîÑ Refresh</button>
          </div>
          <p class="mgmt-note">‚ÑπÔ∏è Changes affect which companies are monitored and initialized on server restart.</p>
        </div>

        <!-- Bot Groups -->
        <div id="categoryGroups"></div>
      </div>
      <div id="connectionStatus" class="connection-status">Connected to server</div>
    </div>

    <script>
      // ============================================
      // STATE
      // ============================================
      let MONITORED_COMPANY_IDS = [];
      const botStatuses = new Map();
      const botActivityMap = new Map();
      let currentSearchTerm = '';
      let showingOnlyActive = false;
      let ws;
      let lastScrollTop = 0;
      window.lastKeyPressed = null;
      window.metaAccountsData = new Map();

      const connectionStatus = document.getElementById('connectionStatus');
      const searchInput = document.getElementById('searchInput');
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

      // ============================================
      // AUTH
      // ============================================
      function checkPassword() {
        const pw = document.getElementById('passwordInput').value;
        if (pw === 'P@ssw0rd') { sessionStorage.setItem('statusAuth', 'true'); showMainContent(); }
        else alert('Incorrect password');
      }
      function showMainContent() {
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initialize();
      }
      if (sessionStorage.getItem('statusAuth') === 'true') showMainContent();
      document.getElementById('passwordInput').addEventListener('keypress', e => { if (e.key === 'Enter') checkPassword(); });

      // ============================================
      // MONITORED COMPANIES
      // ============================================
      async function loadMonitoredCompanies() {
        try {
          const r = await fetch('/api/monitored-companies');
          const d = await r.json();
          if (d.success && d.companies) { MONITORED_COMPANY_IDS = d.companies.map(c => c.companyId); return MONITORED_COMPANY_IDS; }
        } catch (e) { console.error('Error loading monitored companies:', e); }
        return [];
      }
      async function addMonitoredCompany(companyId) {
        try {
          const r = await fetch('/api/monitored-companies', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ companyId }) });
          const d = await r.json();
          if (d.success) { showNotification(`‚úÖ Added ${companyId}`); await refreshMonitoredCompanies(); } else showNotification(`‚ùå ${d.error}`, true);
        } catch (e) { showNotification(`‚ùå ${e.message}`, true); }
      }
      async function removeMonitoredCompany(companyId) {
        if (!confirm(`Remove ${companyId}?`)) return;
        try {
          const r = await fetch(`/api/monitored-companies/${companyId}`, { method: 'DELETE' });
          const d = await r.json();
          if (d.success) { showNotification(`‚úÖ Removed ${companyId}`); await refreshMonitoredCompanies(); } else showNotification(`‚ùå ${d.error}`, true);
        } catch (e) { showNotification(`‚ùå ${e.message}`, true); }
      }
      async function refreshMonitoredCompanies() {
        await loadMonitoredCompanies();
        updateMonitoredCompaniesUI();
        document.getElementById('companyCountBadge').textContent = MONITORED_COMPANY_IDS.length;
        await loadAvailableCompanies();
        await initializeBots();
      }
      function updateMonitoredCompaniesUI() {
        const el = document.getElementById('monitoredCompaniesList');
        if (!el) return;
        if (MONITORED_COMPANY_IDS.length === 0) { el.innerHTML = '<span style="color:var(--gray-400);font-style:italic;font-size:12px;">No companies. Add below.</span>'; return; }
        el.innerHTML = MONITORED_COMPANY_IDS.map(id => `<span class="tag-item">${id}<button onclick="removeMonitoredCompany('${id}')" class="tag-remove" title="Remove">√ó</button></span>`).join('');
      }
      async function loadAvailableCompanies() {
        try {
          const r = await fetch('/api/monitored-companies/available');
          const d = await r.json();
          const sel = document.getElementById('addCompanySelect');
          if (!sel) return;
          while (sel.children.length > 1) sel.removeChild(sel.lastChild);
          if (d.success && d.companies) d.companies.forEach(c => { const o = document.createElement('option'); o.value = c.companyId; o.textContent = `${c.companyId} - ${c.name || 'No name'}`; sel.appendChild(o); });
        } catch (e) { console.error('Error:', e); }
      }
      async function handleAddCompany() {
        const sel = document.getElementById('addCompanySelect');
        if (!sel.value) { showNotification('Select a company', true); return; }
        await addMonitoredCompany(sel.value);
        sel.value = '';
        await loadAvailableCompanies();
      }

      // ============================================
      // NOTIFICATIONS
      // ============================================
      function showNotification(message, isError = false) {
        document.querySelector('.notification')?.remove();
        const n = document.createElement('div');
        n.className = 'notification';
        n.style.background = isError ? 'var(--red)' : 'var(--green)';
        n.textContent = message;
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 3000);
      }

      // ============================================
      // SEARCH & FILTERS
      // ============================================
      searchInput.addEventListener('input', () => { currentSearchTerm = searchInput.value.toLowerCase(); applyFilters(); });
      document.addEventListener('keydown', e => { window.lastKeyPressed = e.key; if (e.key === 'Enter') setTimeout(() => { window.lastKeyPressed = null; }, 1000); });

      function applyFilters() {
        const items = document.querySelectorAll('.bot-item');
        let hasVisible = false;
        items.forEach(item => {
          const nm = item.querySelector('.bot-display-name').textContent.toLowerCase();
          const id = item.querySelector('.bot-id').textContent.toLowerCase();
          const st = item.querySelector('.bot-status').textContent.toLowerCase();
          const active = !!item.querySelector('.bot-activity');
          const match = !currentSearchTerm || nm.includes(currentSearchTerm) || id.includes(currentSearchTerm) || st.includes(currentSearchTerm);
          const matchActive = !showingOnlyActive || active;
          item.classList.toggle('hidden', !match || !matchActive);
          if (match && matchActive) hasVisible = true;
        });
        let nr = document.getElementById('noResults');
        if (!hasVisible) { if (!nr) { nr = document.createElement('div'); nr.id = 'noResults'; nr.className = 'no-results'; nr.textContent = 'No bots found'; document.querySelector('.bot-list')?.appendChild(nr); } }
        else if (nr) nr.remove();
        updateFilteredStats();
      }

      // ============================================
      // RENDER
      // ============================================
      function renderStatuses() {
        lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const catGroups = new Map();
        const sorted = Array.from(botStatuses.entries()).sort((a, b) => a[0].split('_')[0].localeCompare(b[0].split('_')[0]));

        for (const [key, data] of sorted) {
          const [botName] = key.split('_');
          const bd = window.botsData?.find(b => b.botName === botName);
          const cat = bd?.category || 'juta';
          if (!catGroups.has(cat)) catGroups.set(cat, new Map());
          if (!catGroups.get(cat).has(botName)) catGroups.get(cat).set(botName, []);
          catGroups.get(cat).get(botName).push({ ...data, key });
        }

        const groupsDiv = document.getElementById('categoryGroups');
        groupsDiv.innerHTML = '';

        for (const [cat, botsInCat] of catGroups) {
          const catDiv = document.createElement('div');
          const listDiv = document.createElement('div');
          listDiv.className = 'bot-list';

          const hdr = document.createElement('div');
          hdr.className = 'bot-list-header';
          hdr.innerHTML = '<span>Bot</span><span>Status</span><span>Actions</span>';
          listDiv.appendChild(hdr);

          for (const [botName, phones] of botsInCat) {
            const bd = window.botsData?.find(b => b.botName === botName);
            const dispName = bd?.name || botName;
            const isActive = botActivityMap.get(botName);

            phones.forEach(({ status, phoneIndex }, idx) => {
              const item = document.createElement('div');
              item.className = 'bot-item';
              item.id = `bot-${botName}-${phoneIndex}`;

              const phone = bd?.clientPhones?.[phoneIndex];
              const label = phones.length > 1 ? ` (P${idx + 1})` : '';
              const actHtml = idx === 0 && isActive ? '<span class="bot-activity"><span class="dot"></span>Active</span>' : '';

              const cid = bd?.companyId || botName;
              const mk = `${cid}_${phoneIndex}`;
              const md = window.metaAccountsData?.get(mk);
              const ds = getDisplayStatus(status, md);
              const sc = ds.toLowerCase().replace(/\s+/g, '-');

              item.innerHTML = `
                <div class="bot-info">
                  <div class="bot-display-name">
                    ${dispName}${label}
                    ${bd?.plan ? `<span class="plan-badge ${bd.plan.toLowerCase()}">${bd.plan}</span>` : ''}
                    ${bd?.trialEndDate ? '<span class="trial-badge">Trial</span>' : ''}
                    ${actHtml}
                  </div>
                  <div class="bot-id">ID: ${botName}</div>
                  ${phone ? `<div class="bot-id">Phone: ${phone}</div>` : `<div class="bot-id">Phone${phones.length > 1 ? ' ' + (idx + 1) : ''}: Not Set</div>`}
                  ${renderMetaInfo(cid, phoneIndex)}
                </div>
                <span class="bot-status status-${sc}">${ds}</span>
                <div class="bot-actions">
                  ${bd?.trialEndDate ? `<button class="delete-trial-button" onclick="deleteTrialEndDate('${botName}')">Del Trial</button>` : ''}
                  ${idx === 0 ? `<button class="view-unreplied-btn" onclick="showUnrepliedMessages('${cid}')">Unreplied</button>` : ''}
                  ${phones.length === 1 ? `
                    <button class="reinit-button" onclick="reinitializeBot('${botName}',${phoneIndex})">Reinit</button>
                    <button class="disconnect-button" onclick="disconnectBot('${botName}',${phoneIndex})">Disconnect</button>
                  ` : `
                    <button class="reinit-button" onclick="reinitializeBot('${botName}',${phoneIndex})">Reinit P${phoneIndex+1}</button>
                    <button class="disconnect-button" onclick="disconnectBot('${botName}',${phoneIndex})">Disc P${phoneIndex+1}</button>
                  `}
                  ${idx === 0 && phones.length > 1 ? `
                    <button class="reinit-button" onclick="reinitializeBot('${botName}')">Reinit All</button>
                    <button class="disconnect-button" onclick="disconnectBot('${botName}')">Disc All</button>
                  ` : ''}
                  ${idx === 0 ? `<button class="delete-company-button" onclick="deleteCompany('${botName}')">Delete</button>` : ''}
                </div>
              `;
              listDiv.appendChild(item);
            });
          }
          catDiv.appendChild(listDiv);
          groupsDiv.appendChild(catDiv);
        }
        applyFilters();
        if (window.lastKeyPressed !== 'Enter') setTimeout(() => window.scrollTo(0, lastScrollTop), 0);
      }

      function updateBotStatus(botName, status, phoneIndex = 0, qrCode = null) {
        const k = `${botName}_${phoneIndex}`;
        const bd = window.botsData?.find(b => b.botName === botName);
        botStatuses.set(k, { status, phoneIndex, qrCode, displayName: bd?.name, clientPhone: bd?.clientPhones?.[phoneIndex], employeeEmails: bd?.employeeEmails });
        renderStatuses();
        if (searchInput.value) applyFilters(); else updateStats();
      }

      // ============================================
      // STATS
      // ============================================
      function updateStats() {
        const ub = new Set(Array.from(botStatuses.keys()).map(k => k.split('_')[0]));
        if (window.metaAccountsData) window.metaAccountsData.forEach((_, k) => ub.add(k.split('_')[0]));
        let mc = 0, wc = 0;
        const proc = new Set();
        if (window.metaAccountsData) {
          window.metaAccountsData.forEach((md, mk) => {
            if (proc.has(mk)) return;
            if (['meta_direct','meta_embedded','360dialog'].includes(md.connectionType)) {
              const ms = (md.metaStatus || md.status || '').toLowerCase();
              if (md.verifiedName || ms === 'connected' || ms === 'ready') { mc++; proc.add(mk); }
            }
          });
        }
        Array.from(botStatuses.entries()).forEach(([k, b]) => {
          if (proc.has(k)) return;
          const md = window.metaAccountsData?.get(k);
          if (md && ['meta_direct','meta_embedded','360dialog'].includes(md.connectionType)) return;
          if (['ready','authenticated','connected'].includes(b.status.toLowerCase())) { wc++; proc.add(k); }
        });
        const dc = new Set(Array.from(botStatuses.entries()).filter(([k, b]) => {
          const md = window.metaAccountsData?.get(k);
          if (md && ['meta_direct','meta_embedded','360dialog'].includes(md.connectionType) && (md.verifiedName || ['connected','ready'].includes((md.metaStatus||'').toLowerCase()))) return false;
          return ['disconnected','error'].includes(b.status.toLowerCase());
        }).map(([k]) => k.split('_')[0])).size;
        const an = new Set(Array.from(botActivityMap.entries()).filter(([,v]) => v).map(([k]) => k)).size;
        document.getElementById('totalBots').textContent = ub.size;
        document.getElementById('activeBots').textContent = mc + wc;
        document.getElementById('metaConnected').textContent = mc;
        document.getElementById('wwebjsConnected').textContent = wc;
        document.getElementById('disconnectedBots').textContent = dc;
        document.getElementById('currentlyActiveBots').textContent = an;
      }

      function updateFilteredStats() {
        const vis = document.querySelectorAll('.bot-item:not(.hidden)');
        const ready = s => ['ready','authenticated','connected'].includes(s);
        const av = Array.from(vis).filter(i => ready(i.querySelector('.bot-status').textContent.toLowerCase())).length;
        const dv = Array.from(vis).filter(i => ['disconnected','error'].includes(i.querySelector('.bot-status').textContent.toLowerCase())).length;
        let mv = 0, wv = 0;
        Array.from(vis).forEach(i => { const mi = i.querySelector('.meta-verification-info'); const s = i.querySelector('.bot-status').textContent.toLowerCase(); if (ready(s)) { if (mi) mv++; else wv++; } });
        const anv = new Set(Array.from(vis).filter(i => i.querySelector('.bot-activity')).map(i => i.querySelector('.bot-id').textContent.split(':')[1]?.trim())).size;
        document.getElementById('totalBots').textContent = vis.length;
        document.getElementById('activeBots').textContent = av;
        document.getElementById('metaConnected').textContent = mv;
        document.getElementById('wwebjsConnected').textContent = wv;
        document.getElementById('disconnectedBots').textContent = dv;
        document.getElementById('currentlyActiveBots').textContent = anv;
      }

      // ============================================
      // META & BOT INIT
      // ============================================
      async function initializeBots() {
        try {
          const r = await fetch('/api/bots');
          const bots = await r.json();
          const filtered = bots.filter(b => MONITORED_COMPANY_IDS.includes(b.botName));
          filtered.forEach(b => { const pc = parseInt(b.phoneCount) || 1; for (let i = 0; i < pc; i++) updateBotStatus(b.botName, 'Initializing', i, null); });
          window.botsData = filtered;
          populateTestCompanySelect();
          await fetchMetaAccounts();
        } catch (e) { console.error('Error:', e); }
      }

      function getDisplayStatus(ws, md) {
        if (!md) return ws;
        const ms = (md.metaStatus || md.status || '').toLowerCase();
        if (ms === 'connected' || ms === 'ready') return 'Ready';
        if (ms === 'disconnected') return 'Disconnected';
        if (ms === 'pending' || ms === 'pending_review') return 'Pending';
        if (md.verifiedName) return 'Ready';
        if (md.connectionType && ['meta_direct','meta_embedded','360dialog'].includes(md.connectionType)) return md.verifiedName ? 'Ready' : ws;
        return ws;
      }

      async function fetchMetaAccounts() {
        try {
          const r = await fetch('/api/whatsapp/meta-accounts');
          const d = await r.json();
          if (d.success && d.accounts) { d.accounts.forEach(a => window.metaAccountsData.set(`${a.companyId}_${a.phoneIndex}`, a)); renderStatuses(); }
        } catch (e) { console.error('Error:', e); }
      }

      async function verifyMetaAccount(companyId, phoneIndex) {
        const btn = event.target; const orig = btn.textContent; btn.disabled = true; btn.textContent = '...';
        try {
          const r = await fetch(`/api/whatsapp/meta-accounts/${companyId}/${phoneIndex}/verify`);
          const d = await r.json();
          if (d.success) { const k = `${companyId}_${phoneIndex}`; window.metaAccountsData.set(k, { ...(window.metaAccountsData.get(k)||{}), ...d, verifiedName: d.verifiedName, qualityRating: d.qualityRating, metaStatus: d.status }); showNotification(`‚úÖ ${d.verifiedName||'OK'}`); renderStatuses(); }
          else showNotification(d.error || 'Failed', true);
        } catch { showNotification('Error', true); }
        finally { btn.disabled = false; btn.textContent = orig; }
      }

      function renderMetaInfo(cid, pi) {
        const k = `${cid}_${pi}`;
        const md = window.metaAccountsData.get(k);
        if (!md) return '';
        const conn = md.connectionType ? `<span class="meta-connection-badge meta-type-${md.connectionType}">${fmtConn(md.connectionType)}</span>` : '';
        const ver = md.verifiedName ? `<span class="meta-verified-badge"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${md.verifiedName}</span>` : '';
        const qual = md.qualityRating ? `<span class="meta-quality-badge meta-quality-${md.qualityRating}">${md.qualityRating}</span>` : '';
        return `<div class="meta-verification-info">
          <div class="meta-verification-row"><span class="meta-label">Meta API</span>${conn}</div>
          ${md.verifiedName ? `<div class="meta-verification-row"><span class="meta-label">Verified</span>${ver}</div>` : ''}
          ${md.qualityRating ? `<div class="meta-verification-row"><span class="meta-label">Quality</span>${qual}</div>` : ''}
          <div class="meta-verification-row"><span class="meta-label">Status</span><span class="meta-value">${md.metaStatus||md.status||'-'}</span></div>
          <div class="meta-verification-row" style="margin-top:4px;"><button class="verify-meta-btn" onclick="verifyMetaAccount('${cid}',${pi})">Refresh</button></div>
        </div>`;
      }
      function fmtConn(t) { return t === 'meta_direct' ? 'Meta Direct' : t === 'meta_embedded' ? 'Embedded' : t === '360dialog' ? '360dialog' : t; }

      // ============================================
      // WEBSOCKET
      // ============================================
      function connectWebSocket() {
        ws = new WebSocket(`${protocol}//${window.location.host}/status`);
        ws.onmessage = e => { const d = JSON.parse(e.data); if (d.type === 'status_update') updateBotStatus(d.botName, d.status, d.phoneIndex, null); else if (d.type === 'bot_activity') { botActivityMap.set(d.botName, d.isActive); renderStatuses(); updateStats(); } };
        ws.onopen = () => { connectionStatus.style.display = 'block'; connectionStatus.style.color = 'var(--green)'; connectionStatus.textContent = '‚óè Connected'; };
        ws.onclose = () => { connectionStatus.style.display = 'block'; connectionStatus.style.color = 'var(--red)'; connectionStatus.textContent = '‚óè Reconnecting...'; setTimeout(connectWebSocket, 3000); };
        ws.onerror = () => { connectionStatus.style.display = 'block'; connectionStatus.style.color = 'var(--red)'; connectionStatus.textContent = '‚óè Error'; };
      }

      async function initialize() {
        await loadMonitoredCompanies();
        updateMonitoredCompaniesUI();
        document.getElementById('companyCountBadge').textContent = MONITORED_COMPANY_IDS.length;
        await loadAvailableCompanies();
        await initializeBots();
        connectWebSocket();
        setTimeout(updateAutoReplyStatus, 2000);
        fetchProcessHealth();
        setInterval(fetchProcessHealth, 30000);
      }

      // ============================================
      // BOT ACTIONS
      // ============================================
      async function reinitializeBot(botName, phoneIndex) {
        const msg = phoneIndex !== undefined ? `Reinitialize Phone ${phoneIndex+1} of ${botName}?` : `Reinitialize all phones of ${botName}?`;
        if (!confirm(msg)) return;
        try {
          showNotification(`Reinitializing ${botName}...`);
          const r = await fetch('/api/bots/reinitialize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ botName, phoneIndex }) });
          if (!r.ok) throw new Error('Failed');
          if (phoneIndex !== undefined) updateBotStatus(botName, 'Initializing', phoneIndex);
          else Array.from(botStatuses.entries()).filter(([k]) => k.startsWith(botName+'_')).forEach(([k]) => updateBotStatus(botName, 'Initializing', parseInt(k.split('_')[1])));
          showNotification(`${botName} reinitializing`);
        } catch { showNotification('Failed', true); }
      }

      async function disconnectBot(botName, phoneIndex) {
        const msg = phoneIndex !== undefined ? `Disconnect Phone ${phoneIndex+1} of ${botName}?` : `Disconnect all phones of ${botName}?`;
        if (!confirm(msg)) return;
        try {
          showNotification(`Disconnecting ${botName}...`);
          const r = await fetch(`/api/bots/${botName}/disconnect`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phoneIndex }) });
          if (!r.ok) throw new Error('Failed');
          const d = await r.json();
          if (phoneIndex !== undefined) updateBotStatus(botName, 'Disconnected', phoneIndex);
          else Array.from(botStatuses.entries()).filter(([k]) => k.startsWith(botName+'_')).forEach(([k]) => updateBotStatus(botName, 'Disconnected', parseInt(k.split('_')[1])));
          showNotification(d.message || `${botName} disconnected`);
        } catch { showNotification('Failed', true); }
      }

      async function deleteCompany(botName) {
        if (!confirm(`‚ö†Ô∏è Delete company ${botName} and ALL data?`)) return;
        if (!confirm(`üî¥ FINAL: Delete ${botName}?`)) return;
        const inp = prompt(`Type "${botName}" to confirm:`);
        if (inp !== botName) { showNotification('Cancelled', true); return; }
        try {
          showNotification(`Deleting ${botName}...`);
          const r = await fetch(`/api/companies/${botName}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
          if (!r.ok) throw new Error((await r.json()).error || 'Failed');
          Array.from(botStatuses.entries()).filter(([k]) => k.startsWith(botName+'_')).forEach(([k]) => botStatuses.delete(k));
          botActivityMap.delete(botName); renderStatuses(); updateStats();
          showNotification(`‚úÖ ${botName} deleted`);
          setTimeout(() => window.location.reload(), 3000);
        } catch (e) { showNotification(`‚ùå ${e.message}`, true); }
      }

      async function deleteTrialEndDate(botName) {
        if (!confirm(`Delete trial for ${botName}?`)) return;
        try { const r = await fetch(`/api/bots/${botName}/trial-end-date`, { method: 'DELETE' }); if (!r.ok) throw new Error('Failed'); showNotification(`Trial deleted`); await initializeBots(); }
        catch { showNotification('Failed', true); }
      }

      async function updateBotCategory(botId, newCat) {
        if (!newCat) return;
        try { const r = await fetch(`/api/bots/${botId}/category`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category: newCat }) }); if (!r.ok) throw new Error('Failed'); showNotification(`Moved to ${newCat}`); await initializeBots(); }
        catch { showNotification('Failed', true); }
      }

      // ============================================
      // HEADER ACTIONS
      // ============================================
      async function initializeAutomations() {
        const btn = document.getElementById('initAutomationsButton'); btn.disabled = true;
        try { const r = await fetch('/api/initialize-automations', { method: 'POST', headers: { 'Content-Type': 'application/json' } }); const d = await r.json(); if (r.ok) showNotification('‚úÖ Automations initialized'); else throw new Error(d.error); }
        catch (e) { showNotification('‚ùå ' + e.message, true); }
        finally { btn.disabled = false; }
      }

      function debugBotStatuses() {
        const counts = {};
        Array.from(botStatuses.entries()).forEach(([, d]) => { counts[d.status] = (counts[d.status]||0) + 1; });
        showNotification(`Total: ${botStatuses.size} | ${JSON.stringify(counts)}`);
      }

      async function reinitializeAllPending() {
        const btn = document.getElementById('refreshButton'); btn.disabled = true;
        try {
          const toReinit = [...new Set(Array.from(botStatuses.entries()).filter(([,d]) => { const s = d.status.toLowerCase(); return s.includes('initializing') || s === 'error' || s === 'disconnected'; }).map(([k]) => k.split('_')[0]))];
          if (toReinit.length === 0) { showNotification('No bots to reinitialize'); return; }
          showNotification(`Reinitializing ${toReinit.length} bot(s)...`);
          let ok = 0, err = 0;
          for (const bn of toReinit) { try { const r = await fetch('/api/bots/reinitialize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ botName: bn }) }); if (!r.ok) throw 0; ok++; } catch { err++; } }
          showNotification(err === 0 ? `‚úÖ ${ok} reinitialized` : `${ok} OK, ${err} failed`, err > 0);
        } catch { showNotification('Error', true); }
        finally { btn.disabled = false; }
      }

      async function cleanupAllJobs() {
        if (!confirm('Clean up all jobs?')) return;
        const btn = document.getElementById('cleanupJobsButton'); btn.disabled = true;
        try { const r = await fetch('/api/cleanup-jobs', { method: 'POST', headers: { 'Content-Type': 'application/json' } }); if (!r.ok) throw new Error((await r.json()).error); showNotification('‚úÖ Jobs cleaned'); setTimeout(() => location.reload(), 2000); }
        catch (e) { showNotification('‚ùå ' + e.message, true); }
        finally { btn.disabled = false; }
      }

      async function triggerHealthReport() {
        const btn = document.getElementById('healthReportButton'); btn.disabled = true;
        try { const r = await fetch('/api/health-report/trigger', { method: 'POST', headers: { 'Content-Type': 'application/json' } }); if (!r.ok) throw new Error((await r.json()).error); showNotification('‚úÖ Health report sent!'); }
        catch (e) { showNotification('‚ùå ' + e.message, true); }
        finally { btn.disabled = false; }
      }

      document.getElementById('currentlyActiveBots').parentElement.addEventListener('click', () => { showingOnlyActive = !showingOnlyActive; applyFilters(); });

      // ============================================
      // AUTO-REPLY FUNCTIONS
      // ============================================
      async function testAutoReply() {
        const companyId = document.getElementById('testCompanySelect').value;
        const phoneNumber = document.getElementById('testPhoneNumber').value;
        const hoursThreshold = document.getElementById('testHoursSelect').value;
        const resultDiv = document.getElementById('testAutoReplyResult');

        if (!companyId) { showNotification('Select a company', true); return; }
        if (!phoneNumber) { showNotification('Enter a phone number', true); return; }

        const btn = document.getElementById('testAutoReplyButton');
        btn.disabled = true; btn.textContent = 'Testing...';
        resultDiv.className = 'ar-result'; resultDiv.style.display = 'none';

        try {
          const r = await fetch(`/api/auto-reply/test/${companyId}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phoneNumber, hoursThreshold: parseInt(hoursThreshold) })
          });
          const data = await r.json();

          if (data.success) {
            let detailsHtml = '';
            if (data.details) {
              detailsHtml = '<div class="detail-grid">';
              if (data.details.messagesFound !== undefined) detailsHtml += `<span class="detail-label">Messages found:</span><span class="detail-value">${data.details.messagesFound}</span>`;
              if (data.details.unrepliedCount !== undefined) detailsHtml += `<span class="detail-label">Unreplied:</span><span class="detail-value">${data.details.unrepliedCount}</span>`;
              if (data.details.lastCustomerMessage) detailsHtml += `<span class="detail-label">Last message:</span><span class="detail-value">"${data.details.lastCustomerMessage}"</span>`;
              if (data.details.lastCustomerMessageTime) detailsHtml += `<span class="detail-label">Time:</span><span class="detail-value">${new Date(data.details.lastCustomerMessageTime).toLocaleString()}</span>`;
              if (data.details.lastBotReplyTime) detailsHtml += `<span class="detail-label">Last bot reply:</span><span class="detail-value">${new Date(data.details.lastBotReplyTime).toLocaleString()}</span>`;
              if (data.details.lastBotReplyContent) detailsHtml += `<span class="detail-label">Bot said:</span><span class="detail-value">"${data.details.lastBotReplyContent}"</span>`;
              if (data.reason) detailsHtml += `<span class="detail-label">Reason:</span><span class="detail-value">${data.reason}</span>`;
              detailsHtml += '</div>';
            }
            resultDiv.className = 'ar-result success';
            resultDiv.innerHTML = `<strong>${data.wouldReply ? 'üîî Would Reply' : '‚úÖ No Reply Needed'}</strong> ‚Äî ${data.message}${detailsHtml}`;
          } else {
            resultDiv.className = 'ar-result error';
            resultDiv.innerHTML = `<strong>‚ùå Error</strong> ‚Äî ${data.error || data.message}`;
          }
        } catch (e) {
          resultDiv.className = 'ar-result error';
          resultDiv.innerHTML = `<strong>‚ùå Network Error</strong> ‚Äî ${e.message}`;
        } finally { btn.disabled = false; btn.textContent = 'Test Auto-Reply'; }
      }

      async function showUnrepliedMessages(companyId) {
        try {
          showNotification(`Fetching unreplied for ${companyId}...`);
          const r = await fetch(`/api/auto-reply/unreplied/${companyId}?hoursThreshold=24`);
          const d = await r.json();
          if (d.success) { if (d.data.count === 0) showNotification(`‚úÖ No unreplied for ${companyId}`); else showUnrepliedModal(companyId, d.data); }
          else showNotification(`‚ùå ${d.error}`, true);
        } catch { showNotification('‚ùå Network error', true); }
      }

      function showUnrepliedModal(companyId, data) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-box">
            <div class="modal-header">
              <h2>Unreplied ‚Äî ${companyId}</h2>
              <div class="modal-header-actions">
                <button class="modal-btn orange" onclick="showReplyAllConfirm('${companyId}', ${JSON.stringify(data.messages).replace(/"/g, '&quot;')})">Reply to All</button>
                <button class="modal-btn gray" onclick="this.closest('.modal-overlay').remove()">Close</button>
              </div>
            </div>
            <div class="modal-body">
              <p class="modal-subtitle">${data.count} unreplied message${data.count !== 1 ? 's' : ''} in the last ${data.hoursThreshold||24} hours</p>
              ${data.messages.map((msg, i) => `
                <div class="msg-card">
                  <div class="msg-top">
                    <div class="msg-phone-row">
                      <input type="checkbox" id="msg-${i}" checked />
                      <label for="msg-${i}">${msg.phone || msg.name || 'Unknown'}</label>
                    </div>
                    <div class="msg-actions">
                      <span class="msg-time">${msg.timestamp ? new Date(msg.timestamp).toLocaleString() : 'N/A'}</span>
                      <button class="msg-reply-btn" onclick="replyToSingle('${companyId}','${msg.phone}',${i})">Reply Now</button>
                    </div>
                  </div>
                  ${msg.content ? `<div class="msg-content">${msg.content}</div>` : ''}
                  <div class="msg-meta">Last reply: ${msg.lastReplyTime ? new Date(msg.lastReplyTime).toLocaleString() : 'Never'}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function showReplyAllConfirm(companyId, messages) {
        const sel = [], unsel = [];
        messages.forEach((m, i) => { const cb = document.getElementById(`msg-${i}`); if (cb?.checked) sel.push(m); else unsel.push(m); });
        if (sel.length === 0) { showNotification('Select at least one', true); return; }

        const modal = document.createElement('div');
        modal.className = 'modal-overlay z2';
        modal.innerHTML = `
          <div class="modal-box" style="max-width:560px;">
            <div class="modal-header">
              <h2>Confirm Auto-Reply</h2>
              <button class="modal-btn gray" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            </div>
            <div class="modal-body">
              <p style="margin-bottom:12px;font-size:14px;">Send auto-replies to <strong style="color:var(--orange);">${sel.length}</strong> of ${messages.length} contacts?</p>
              ${unsel.length > 0 ? `<p style="color:var(--orange);font-size:13px;margin-bottom:12px;">‚ö†Ô∏è ${unsel.length} skipped</p>` : ''}
              <div style="max-height:200px;overflow-y:auto;margin-bottom:16px;">
                ${sel.map(m => `<div class="msg-card" style="padding:8px 12px;"><strong style="font-size:13px;">${m.phone}</strong><div class="msg-content" style="font-size:12px;color:var(--gray-500);margin:2px 0 0;">${(m.content||'').substring(0,60)}${(m.content||'').length>60?'...':''}</div></div>`).join('')}
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="modal-btn gray" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="modal-btn green" onclick="execReplyAll('${companyId}',${JSON.stringify(sel).replace(/"/g,'&quot;')})">Send (${sel.length})</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      async function execReplyAll(companyId, msgs) {
        document.querySelector('.modal-overlay.z2')?.remove();
        try {
          showNotification(`Sending ${msgs.length} replies...`);
          let ok = 0, err = 0;
          for (const m of msgs) { try { const r = await fetch(`/api/auto-reply/test/${companyId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phoneNumber: m.phone, hoursThreshold: 12 }) }); const d = await r.json(); if (d.success) ok++; else err++; } catch { err++; } }
          showNotification(err === 0 ? `‚úÖ Sent ${ok} replies` : `${ok} sent, ${err} failed`, err > 0);
          setTimeout(() => document.querySelector('.modal-overlay')?.remove(), 2000);
        } catch (e) { showNotification(`‚ùå ${e.message}`, true); }
      }

      async function updateAutoReplyStatus() {
        const companies = [...new Set(window.botsData?.map(b => b.companyId || b.botName).filter(Boolean) || [])];
        for (const cid of companies) { try { const r = await fetch(`/api/auto-reply/status/${cid}`); const d = await r.json(); if (d.success) console.log(`AR status ${cid}:`, d.data); } catch (e) { console.error(e); } }
      }

      async function replyToSingle(companyId, phone, idx) {
        try {
          showNotification(`Replying to ${phone}...`);
          const r = await fetch(`/api/auto-reply/test/${companyId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phoneNumber: phone, hoursThreshold: 12 }) });
          const d = await r.json();
          if (d.success) {
            showNotification(`‚úÖ Replied to ${phone}`);
            const btns = document.querySelectorAll(`button[onclick*="replyToSingle('${companyId}','${phone}',${idx})"]`);
            if (btns.length) { btns[0].textContent = 'Sent ‚úì'; btns[0].style.background = 'var(--green)'; btns[0].disabled = true; }
          } else showNotification(`‚ùå ${d.error}`, true);
        } catch (e) { showNotification(`‚ùå ${e.message}`, true); }
      }

      // ============================================
      // PROCESS HEALTH
      // ============================================
      function fmtUptime(secs) {
        if (!secs && secs !== 0) return '‚Äî';
        const h = Math.floor(secs / 3600);
        const m = Math.floor((secs % 3600) / 60);
        const s = secs % 60;
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }

      async function fetchProcessHealth() {
        try {
          const r = await fetch('/health/all');
          const d = await r.json();
          ['api', 'wwebjs', 'meta'].forEach(proc => {
            const info = d[proc] || {};
            const st = info.status || 'unknown';
            const dot = document.getElementById(`dot-${proc}`);
            const badge = document.getElementById(`badge-${proc}`);
            const uptime = document.getElementById(`uptime-${proc}`);
            if (dot) dot.className = `proc-dot ${st}`;
            if (badge) { badge.className = `proc-badge ${st}`; badge.textContent = st === 'healthy' ? 'Online' : st === 'down' ? 'Down' : 'Unknown'; }
            if (uptime) uptime.textContent = fmtUptime(info.uptime);
          });
        } catch {
          ['api', 'wwebjs', 'meta'].forEach(proc => {
            const b = document.getElementById(`badge-${proc}`);
            if (b) { b.className = 'proc-badge down'; b.textContent = 'Error'; }
          });
        }
      }

      function populateTestCompanySelect() {
        const sel = document.getElementById('testCompanySelect');
        if (!sel || !window.botsData) return;
        const cids = [...new Set(window.botsData.map(b => b.companyId || b.botName).filter(Boolean))];
        while (sel.children.length > 1) sel.removeChild(sel.lastChild);
        cids.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = `Company ${c}`; sel.appendChild(o); });
      }

      initialize();
    </script>
  </body>
</html>

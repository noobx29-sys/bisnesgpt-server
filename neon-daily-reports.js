const cron = require("node-cron");
const moment = require("moment-timezone");

const {
  getContactsByChannel,
  saveSetting,
  getSetting
} = require('./neon-contact-operations');

const {
  formatChannelDetails
} = require('./neon-webhook-utils');

// ======================
// DAILY REPORTS SYSTEM
// ======================

// Store cron jobs by company ID
const dailyReportCrons = new Map();

async function initializeDailyReports() {
  try {
    console.log('ðŸš€ Initializing daily reports system...');
    
    // Only get company 0123
    const companyId = '0123';
    
    // Get reporting settings
    const settings = await getSetting(companyId, 'reporting', 'dailyReport');
    
    if (settings?.value?.enabled && settings?.value?.groupId) {
      console.log(`âš™ï¸ Setting up daily report for company ${companyId}:`, {
        groupId: settings.value.groupId
      });

      const cronTime = '30 0 * * *';
      const cronJob = cron.schedule(cronTime, async () => {
        try {
          console.log('â° Running daily report for company 0123');
          
          // Get yesterday's timestamp range
          const yesterday = moment().tz('Asia/Kuala_Lumpur').subtract(1, 'day');
          const startOfYesterday = yesterday.startOf('day').unix();
          const endOfYesterday = yesterday.endOf('day').unix();
          
          console.log('ðŸ“Š Gathering statistics...');
          const channelStats = await getContactsByChannel('0123', startOfYesterday, endOfYesterday);
          console.log('Channel statistics:', channelStats);

          const message = `ðŸ“Š *Daily Lead Report*\n\n` +
                       `ðŸ“… Date: ${new Date().toLocaleDateString()}\n\n` +
                       `ðŸ“± *Channel Breakdown*\n` +
                       `â”œâ”€ Revotrend: ${channelStats.revotrend.count} leads\n` +
                       `â”œâ”€ StoreGuru: ${channelStats.storeguru.count} leads\n` +
                       `â””â”€ ShipGuru: ${channelStats.shipguru.count} leads\n\n` +
                       `ðŸ“ˆ *Total New Leads: ${channelStats.total}*\n\n` +
                       `*Detailed Breakdown:*\n\n` +
                       formatChannelDetails('ðŸ¢ Revotrend Leads:', channelStats.revotrend.contacts) +
                       formatChannelDetails('ðŸª StoreGuru Leads:', channelStats.storeguru.contacts) +
                       formatChannelDetails('ðŸš¢ ShipGuru Leads:', channelStats.shipguru.contacts) +
                       `\nGenerated by Juta AI`;
          
          console.log(`ðŸ“¤ Sending report to group ${settings.value.groupId}`);
          // Note: You'll need to pass the botMap here or handle WhatsApp client access
          // await botData[1].client.sendMessage(settings.value.groupId, message);

          const isabelleChatId = '60178663360@c.us';
          console.log(`ðŸ“¤ Sending report to Isabelle at ${isabelleChatId}`);
          // await botData[1].client.sendMessage(isabelleChatId, message);
          console.log('âœ… Report sent successfully');
          
          // Update last run time
          await saveSetting(companyId, 'reporting', 'dailyReport', {
            ...settings.value,
            lastRun: new Date()
          });
          console.log('ðŸ“ Updated last run timestamp');

        } catch (error) {
          console.error('âŒ Error sending daily report:', error);
        }
      }, {
        timezone: "Asia/Kuala_Lumpur"
      });

      // Store cron job reference
      dailyReportCrons.set('0123', cronJob);
      console.log('âœ… Daily report scheduled for company 0123 at 12:30 AM');
    }

    console.log('ðŸŽ‰ Daily reports initialization complete');
    console.log('ðŸ“‹ Active report schedules:', Array.from(dailyReportCrons.keys()));
  } catch (error) {
    console.error('âŒ Error initializing daily reports:', error);
  }
}

// API endpoint to manage daily reports
async function handleDailyReportManagement(req, res, botMap) {
  const { companyId } = req.params;
  const { enabled, groupId, time } = req.body;

  try {
    console.log(`ðŸ“ Received daily report configuration update for company ${companyId}:`, {
      enabled,
      groupId,
      time,
    });

    if (enabled) {
      // Validate required fields
      if (!groupId || !time) {
        console.error("âŒ Missing required fields");
        return res.status(400).json({
          success: false,
          error: "GroupId and time are required when enabling reports",
        });
      }

      // Validate time format
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(time)) {
        console.error("âŒ Invalid time format");
        return res.status(400).json({
          success: false,
          error: "Time must be in HH:MM format (24-hour)",
        });
      }

      console.log(`âš™ï¸ Enabling daily report for company ${companyId}`);
      await saveSetting(companyId, 'reporting', 'dailyReport', {
        enabled: true,
        time: time,
        groupId,
        lastRun: null,
      });

      // Stop existing cron if running
      const existingCron = dailyReportCrons.get(companyId);
      if (existingCron) {
        console.log(`ðŸ›‘ Stopping existing cron job for company ${companyId}`);
        existingCron.stop();
      }

      // Parse the time
      const [hours, minutes] = time.split(':').map(Number);

      // Start new cron job
      const cronTime = `${minutes} ${hours} * * *`;
      const newCron = cron.schedule(
        cronTime,
        async () => {
          try {
            console.log(`â° Running daily report for company ${companyId}`);
            
            // Get yesterday's timestamp range
            const yesterday = moment().tz('Asia/Kuala_Lumpur').subtract(1, 'day');
            const startOfYesterday = yesterday.startOf('day').unix();
            const endOfYesterday = yesterday.endOf('day').unix();
            
            const channelStats = await getContactsByChannel(companyId, startOfYesterday, endOfYesterday);
            const message =
              `ðŸ“Š *Daily Lead Report*\n\n` +
              `ðŸ“… Date: ${new Date().toLocaleDateString()}\n\n` +
              `ðŸ“± *Channel Breakdown*\n` +
              `â”œâ”€ Revotrend: ${channelStats.revotrend.count} leads\n` +
              `â”œâ”€ StoreGuru: ${channelStats.storeguru.count} leads\n` +
              `â””â”€ ShipGuru: ${channelStats.shipguru.count} leads\n\n` +
              `ðŸ“ˆ *Total New Leads: ${channelStats.total}*\n\n` +
              `*Detailed Breakdown:*\n\n` +
              formatChannelDetails("ðŸ¢ Revotrend Leads:", channelStats.revotrend.contacts) +
              formatChannelDetails("ðŸª StoreGuru Leads:", channelStats.storeguru.contacts) +
              formatChannelDetails("ðŸš¢ ShipGuru Leads:", channelStats.shipguru.contacts) +
              `\nGenerated by Juta AI`;

            // Note: You'll need to pass the botMap here or handle WhatsApp client access
            // await botData[1].client.sendMessage(groupId, message);
            const isabelleChatId = '60178663360@c.us';
            console.log(`ðŸ“¤ Sending report to Isabelle at ${isabelleChatId}`);
            // await botData[1].client.sendMessage(isabelleChatId, message);

            await saveSetting(companyId, 'reporting', 'dailyReport', {
              enabled: true,
              time: time,
              groupId,
              lastRun: new Date()
            });
          } catch (error) {
            console.error(`âŒ Error sending daily report:`, error);
          }
        },
        {
          timezone: "Asia/Kuala_Lumpur",
        }
      );

      // Store the new cron job
      dailyReportCrons.set(companyId, newCron);
      console.log(`âœ… New cron job scheduled for company ${companyId} at ${time}`);

      res.json({
        success: true,
        message: `Daily report enabled and scheduled for ${time}`,
        nextRun: time,
      });
    } else {
      console.log(`âš™ï¸ Disabling daily report for company ${companyId}`);
      // Disable reporting
      const existingCron = dailyReportCrons.get(companyId);
      if (existingCron) {
        existingCron.stop();
        dailyReportCrons.delete(companyId);
        console.log(`ðŸ›‘ Stopped cron job for company ${companyId}`);
      }

      await saveSetting(companyId, 'reporting', 'dailyReport', {
        enabled: false,
        time: null,
        groupId: null,
      });

      res.json({
        success: true,
        message: "Daily report disabled",
      });
    }

    console.log("ðŸ“‹ Current active report schedules:", Array.from(dailyReportCrons.keys()));
  } catch (error) {
    console.error("âŒ Error managing daily report:", error);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
}

// Manual trigger endpoint for testing
async function handleManualReportTrigger(req, res, botMap) {
  const { companyId } = req.params;

  try {
    console.log(`ðŸ”„ Manual trigger requested for company ${companyId}`);
    const settings = await getSetting(companyId, 'reporting', 'dailyReport');
    
    if (!settings?.value?.enabled) {
      console.error('âŒ Daily reporting is not enabled for this company');
      return res.status(400).json({ 
        success: false, 
        error: 'Daily reporting is not enabled for this company' 
      });
    }

    const { groupId } = settings.value;
    
    // Get yesterday's timestamp range
    const yesterday = moment().tz('Asia/Kuala_Lumpur').subtract(1, 'day');
    const startOfYesterday = yesterday.startOf('day').unix();
    const endOfYesterday = yesterday.endOf('day').unix();
    
    console.log(`ðŸ“Š Gathering statistics for manual report...`);
    const channelStats = await getContactsByChannel(companyId, startOfYesterday, endOfYesterday);
    
    const message = `ðŸ“Š *Daily Lead Report (Manual Trigger)*\n\n` +
                   `ðŸ“… Date: ${new Date().toLocaleDateString()}\n\n` +
                   `ðŸ“± *Channel Breakdown*\n` +
                   `â”œâ”€ Revotrend: ${channelStats.revotrend.count} leads\n` +
                   `â”œâ”€ StoreGuru: ${channelStats.storeguru.count} leads\n` +
                   `â””â”€ ShipGuru: ${channelStats.shipguru.count} leads\n\n` +
                   `ðŸ“ˆ *Total New Leads: ${channelStats.total}*\n\n` +
                   `*Detailed Breakdown:*\n\n` +
                   formatChannelDetails('ðŸ¢ Revotrend Leads:', channelStats.revotrend.contacts) +
                   formatChannelDetails('ðŸª StoreGuru Leads:', channelStats.storeguru.contacts) +
                   formatChannelDetails('ðŸš¢ ShipGuru Leads:', channelStats.shipguru.contacts) +
                   `\nGenerated by Juta AI`;
    
    console.log(`ðŸ“¤ Sending manual report to group ${groupId}`);
    // Note: You'll need to pass the botMap here or handle WhatsApp client access
    // await botData[1].client.sendMessage(groupId, message);
    const isabelleChatId = '60178663360@c.us';
    console.log(`ðŸ“¤ Sending manual report to Isabelle at ${isabelleChatId}`);
    // await botData[1].client.sendMessage(isabelleChatId, message);
    
    res.json({ 
      success: true, 
      message: 'Report triggered successfully',
      stats: channelStats
    });

  } catch (error) {
    console.error('âŒ Error triggering daily report:', error);
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
}

// Express route handlers
function setupDailyReportRoutes(app, botMap) {
  app.post("/api/daily-report/:companyId", async (req, res) => {
    await handleDailyReportManagement(req, res, botMap);
  });

  app.post('/api/daily-report/:companyId/trigger', async (req, res) => {
    await handleManualReportTrigger(req, res, botMap);
  });
}

module.exports = {
  initializeDailyReports,
  handleDailyReportManagement,
  handleManualReportTrigger,
  setupDailyReportRoutes
}; 
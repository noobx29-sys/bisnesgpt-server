 //@version=5
indicator("Multi-Indicator Trading Signals", overlay=true, shorttitle="MITS")

// === INDICATOR INPUTS ===

// 1. EMA Inputs
ema_short_length = input.int(50, "Short EMA Length", minval=1)
ema_long_length  = input.int(200, "Long EMA Length", minval=1)

// 2. MACD Inputs
macd_fast_length    = input.int(12, "MACD Fast Length", minval=1)
macd_slow_length    = input.int(26, "MACD Slow Length", minval=1)
macd_signal_length  = input.int(9,  "MACD Signal Length", minval=1)

// 3. RSI Inputs
rsi_length       = input.int(14, "RSI Length", minval=1)
rsi_buy_level    = input.int(30, "RSI Buy Level", minval=1, maxval=100)
rsi_sell_level   = input.int(70, "RSI Sell Level", minval=1, maxval=100)

// 4. ADX Inputs
di_length               = input.int(14, "DI Length", minval=1)
adx_smoothing           = input.int(14, "ADX Smoothing", minval=1)
adx_threshold_buy        = input.int(25, "ADX Threshold for Buy/Sell", minval=1)
adx_threshold_avoid_low  = input.int(20, "ADX Avoid Trading Lower Bound", minval=1)
adx_threshold_avoid_high = input.int(25, "ADX Avoid Trading Upper Bound", minval=1)

// 5. Bollinger Bands Inputs
bb_length = input.int(20, "Bollinger Bands Length", minval=1)
bb_mult   = input.float(2.0, "Bollinger Bands StdDev", step=0.1)

// === INDICATOR CALCULATIONS ===

// 1. Moving Averages (EMA 50 & 200)
ema_short = ta.ema(close, ema_short_length)
ema_long  = ta.ema(close, ema_long_length)

// 2. MACD
[macdLine, signalLine, _] = ta.macd(close, macd_fast_length, macd_slow_length, macd_signal_length)

// 3. RSI
rsi = ta.rsi(close, rsi_length)

// 4. ADX
[diPlus, diMinus, adx] = ta.dmi(di_length, adx_smoothing)

// 5. Bollinger Bands
[bb_middle, bb_upper, bb_lower] = ta.bb(close, bb_length, bb_mult)

// === TRADING SIGNALS ===

// 1. Moving Averages Signals
ema_buy  = ema_short > ema_long
ema_sell = ema_short <= ema_long

// 2. MACD Signals
macd_buy  = macdLine > signalLine
macd_sell = macdLine <= signalLine

// 3. RSI Signals
rsi_buy  = rsi < rsi_buy_level
rsi_sell = rsi >= rsi_sell_level

// 4. ADX Signals
adx_strong  = adx > adx_threshold_buy
adx_buy     = adx_strong and (diPlus > diMinus)
adx_sell    = adx_strong and (diMinus > diPlus)

// Ensure ADX always shows BUY or SELL based on trend if not strong
adx_buy := adx_strong ? adx_buy : (ema_short > ema_long)
adx_sell := adx_strong ? adx_sell : (ema_short <= ema_long)

// 5. Bollinger Bands Signals
// Always show BUY or SELL based on position relative to bands
bb_buy  = close > bb_lower
bb_sell = close <= bb_upper

// === TABLE SETTINGS ===

// Initialize tables only once
var table indicators_table = table.new(position.top_right, 2, 6, border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)
var table signal_table     = table.new(position.bottom_center, 2, 2, border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)

if barstate.islast
    // === INDICATORS TABLE ===
    // Header
    table.cell(indicators_table, 0, 0, "Indicator", bgcolor=color.white, text_color=color.black, text_size=size.small, text_halign=text.align_center)
    table.cell(indicators_table, 1, 0, "Signal", bgcolor=color.white, text_color=color.black, text_size=size.small, text_halign=text.align_center)
    
    // 1. MACD
    signal_macd = macd_buy ? "BUY" : "SELL"
    color_macd  = macd_buy ? color.green : color.red
    table.cell(indicators_table, 0, 1, "MACD", bgcolor=color.white, text_color=color.black, text_size=size.small)
    table.cell(indicators_table, 1, 1, signal_macd, bgcolor=color.white, text_color=color_macd, text_size=size.small, text_halign=text.align_center)
    
    // 2. Moving Averages
    signal_ma  = ema_buy ? "BUY" : "SELL"
    color_ma   = ema_buy ? color.green : color.red
    ema_label  = "EMA " + str.tostring(ema_short_length) + "/" + str.tostring(ema_long_length)
    table.cell(indicators_table, 0, 2, ema_label, bgcolor=color.white, text_color=color.black, text_size=size.small)
    table.cell(indicators_table, 1, 2, signal_ma, bgcolor=color.white, text_color=color_ma, text_size=size.small, text_halign=text.align_center)
    
    // 3. Bollinger Bands
    signal_bb  = bb_buy ? "BUY" : "SELL"
    color_bb   = bb_buy ? color.green : color.red
    table.cell(indicators_table, 0, 3, "Bollinger Bands", bgcolor=color.white, text_color=color.black, text_size=size.small)
    table.cell(indicators_table, 1, 3, signal_bb, bgcolor=color.white, text_color=color_bb, text_size=size.small, text_halign=text.align_center)
    
    // 4. ADX
    signal_adx = adx_buy ? "BUY" : "SELL"
    color_adx  = adx_buy ? color.green : color.red
    table.cell(indicators_table, 0, 4, "ADX", bgcolor=color.white, text_color=color.black, text_size=size.small)
    table.cell(indicators_table, 1, 4, signal_adx, bgcolor=color.white, text_color=color_adx, text_size=size.small, text_halign=text.align_center)
    
    // 5. RSI
    signal_rsi = rsi_buy ? "BUY" : "SELL"
    color_rsi  = rsi_buy ? color.green : color.red
    table.cell(indicators_table, 0, 5, "RSI", bgcolor=color.white, text_color=color.black, text_size=size.small)
    table.cell(indicators_table, 1, 5, signal_rsi, bgcolor=color.white, text_color=color_rsi, text_size=size.small, text_halign=text.align_center)
    
    // === SIGNAL TABLE ===
    // Initialize overall_signal and overall_color
    var string overall_signal = ""
    var color  overall_color  = color.white
    
    // Count buy and sell signals
    buy_count  = (macd_buy ? 1 : 0) + (ema_buy ? 1 : 0) + (bb_buy ? 1 : 0) + (adx_buy ? 1 : 0) + (rsi_buy ? 1 : 0)
    sell_count = (macd_sell ? 1 : 0) + (ema_sell ? 1 : 0) + (bb_sell ? 1 : 0) + (adx_sell ? 1 : 0) + (rsi_sell ? 1 : 0)
    
    // Determine overall signal based on majority
    if buy_count > sell_count
        overall_signal := "BUY"
        overall_color  := color.green
    else
        overall_signal := "SELL"
        overall_color  := color.red
    
    // Populate SIGNAL TABLE
    // Header
    table.cell(signal_table, 0, 0, "Overall Signal", bgcolor=color.white, text_color=color.black, text_size=size.small, text_halign=text.align_center)
    // Signal
    table.cell(signal_table, 1, 0, overall_signal, bgcolor=color.white, text_color=overall_color, text_size=size.small, text_halign=text.align_center)
